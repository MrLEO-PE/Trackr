<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PE Learning Hub</title>
    <!-- Firebase SDK (optional) -->
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-firestore-compat.js"></script>
    <!-- Paste your firebaseConfig into /_sdk/firebase_config.js or set window.FIREBASE_CONFIG before data_sdk loads -->
    <script src="/_sdk/firebase_config.js"></script>
    <script src="/_sdk/data_sdk.js"></script>
    <script src="/_sdk/element_sdk.js"></script>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #667eea;
            --bg-secondary: #764ba2;
            --surface-light: #ffffff;
            --surface-dark: #1a1a1a;
            --text-light: #1a1a1a;
            --text-dark: #ffffff;
            --text-secondary: #666666;
            --accent-primary: #667eea;
            --accent-secondary: #28a745;
            --house-red: #dc3545;
            --house-green: #28a745;
            --house-yellow: #ffc107;
            --house-blue: #007bff;
            --border-light: #e0e0e0;
            --border-dark: #333333;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --surface-light: #0f3460;
            --text-light: #ffffff;
            --text-secondary: #cccccc;
            --border-light: #333333;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        html {
            height: 100%;
        }

        /* Authentication Screens */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100%;
            padding: 1rem;
        }

        .auth-card {
            background: var(--surface-light);
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
            transition: all 0.3s ease;
        }

        .auth-card h1 {
            color: var(--text-light);
            font-size: 2rem;
            margin-bottom: 0.5rem;
            font-weight: 800;
        }

        .auth-card p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .user-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .user-type-btn {
            padding: 1.5rem;
            border: 2px solid var(--border-light);
            background: var(--surface-light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .user-type-btn.active {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: white;
        }

        .user-type-btn:hover {
            border-color: var(--accent-primary);
        }

        .user-type-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .user-type-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid var(--border-light);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: var(--surface-light);
            color: var(--text-light);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .photo-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .photo-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--text-secondary);
            background: var(--surface-light);
            overflow: hidden;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .photo-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background: var(--surface-light);
            color: var(--text-light);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .photo-btn:hover {
            border-color: var(--accent-primary);
            background: rgba(102, 126, 234, 0.1);
        }

        .house-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .house-btn {
            padding: 1rem;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
        }

        .house-btn.red { background: var(--house-red); }
        .house-btn.green { background: var(--house-green); }
        .house-btn.yellow { background: var(--house-yellow); color: #333; }
        .house-btn.blue { background: var(--house-blue); }

        .house-btn.selected {
            border-color: var(--text-light);
            transform: scale(1.05);
        }

        .auth-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--bg-secondary) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .switch-auth {
            margin-top: 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .switch-auth button {
            background: none;
            border: none;
            color: var(--accent-primary);
            cursor: pointer;
            text-decoration: underline;
        }

        /* Main App Layout */
        .app-container {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header h1 {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: rgba(255,255,255,0.9);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-details {
            text-align: right;
            font-size: 0.9rem;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 1rem;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .nav-tab.active {
            color: white;
            border-bottom-color: white;
            background: rgba(255,255,255,0.1);
        }

        .nav-tab:hover {
            color: white;
            background: rgba(255,255,255,0.05);
        }

        /* Dashboard */
        .dashboard {
            padding: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            height: 100%;
            overflow-y: auto;
        }

        .dashboard-card {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .dashboard-card h3 {
            color: var(--text-light);
            font-size: 1.3rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        /* Avatar Display */
        .avatar-section {
            text-align: center;
            margin-bottom: 2rem;
        }

        .avatar-display {
            width: 200px;
            height: 300px;
            margin: 0 auto 1rem;
            position: relative;
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .avatar-body {
            width: 100%;
            height: 80%;
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
        }

        .avatar-head {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            border: 3px solid white;
            overflow: hidden;
            background: #f0f0f0;
        }

        .avatar-head img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .level-badge {
            background: var(--accent-primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .house-points {
            color: var(--text-light);
            font-weight: 600;
        }

        /* Progress Rings */
        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 1rem auto;
            position: relative;
        }

        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 8;
        }

        .progress-ring .bg {
            stroke: var(--border-light);
        }

        .progress-ring .progress {
            stroke: var(--accent-primary);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-light);
        }

        /* House Leaderboard */
        .house-leaderboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .house-card {
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            color: white;
            font-weight: 600;
            position: relative;
            border: 3px solid transparent;
        }

        .house-card.red { 
            background: var(--house-red); 
            border-color: #8B0000;
        }
        .house-card.green { 
            background: var(--house-green); 
            border-color: #006400;
        }
        .house-card.yellow { 
            background: var(--house-yellow); 
            color: #333; 
            border-color: #B8860B;
        }
        .house-card.blue { 
            background: var(--house-blue); 
            border-color: #000080;
        }

        /* Colorblind-friendly patterns */
        .house-card::before {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .house-card.red::before {
            background: repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(255,255,255,0.3) 2px, rgba(255,255,255,0.3) 4px);
        }

        .house-card.green::before {
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.3) 2px, rgba(255,255,255,0.3) 4px);
        }

        .house-card.yellow::before {
            background: repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,0.3) 2px, rgba(0,0,0,0.3) 4px);
        }

        .house-card.blue::before {
            background: repeating-linear-gradient(-45deg, transparent, transparent 2px, rgba(255,255,255,0.3) 2px, rgba(255,255,255,0.3) 4px);
        }

        .house-name {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .house-total {
            font-size: 2rem;
            font-weight: 800;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Sports Module */
        .sports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            overflow-y: auto;
        }

        .sport-card {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .sport-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        .sport-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .sport-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .sport-progress {
            font-size: 0.9rem;
            color: var(--accent-primary);
            font-weight: 500;
        }

        /* Sport Detail View */
        .sport-detail-container {
            padding: 2rem;
            overflow-y: auto;
            height: 100%;
        }

        .sport-detail-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            color: white;
        }

        .sport-detail-header h2 {
            font-size: 2rem;
            font-weight: 700;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .lesson-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .lesson-tile {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }

        .lesson-tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        .lesson-tile.assessment {
            border: 3px solid var(--accent-primary);
            background: linear-gradient(135deg, var(--surface-light) 0%, rgba(102, 126, 234, 0.1) 100%);
        }

        .lesson-tile.skills {
            border: 3px solid var(--accent-secondary);
            background: linear-gradient(135deg, var(--surface-light) 0%, rgba(40, 167, 69, 0.1) 100%);
        }

        .lesson-tile.history {
            border: 3px solid var(--house-yellow);
            background: linear-gradient(135deg, var(--surface-light) 0%, rgba(255, 193, 7, 0.1) 100%);
        }

        .lesson-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
        }

        .lesson-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .lesson-type {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .lesson-status {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }

        .lesson-status.locked {
            background: var(--text-secondary);
        }

        /* Assessment View */
        .assessment-container, .skills-container, .history-container, .lesson-container {
            padding: 2rem;
            overflow-y: auto;
            height: 100%;
        }

        .assessment-header, .skills-header, .history-header, .lesson-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            color: white;
        }

        .assessment-header h2, .skills-header h2, .history-header h2, .lesson-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .assessment-content {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .skill-assessment {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-light);
        }

        .skill-assessment:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .skill-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .skill-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .skill-levels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .skill-level {
            padding: 1rem;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .skill-level:hover {
            border-color: var(--accent-primary);
        }

        .skill-level.selected {
            border-color: var(--accent-primary);
            background: rgba(102, 126, 234, 0.1);
        }

        .level-number {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
        }

        .level-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .level-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .assessment-actions {
            text-align: center;
        }

        .assessment-btn {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--bg-secondary) 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .assessment-btn:hover {
            transform: translateY(-2px);
        }

        .assessment-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Quiz Module */
        .quiz-map-container {
            padding: 2rem;
            overflow-y: auto;
            height: 100%;
        }

        .quiz-map-header {
            text-align: center;
            margin-bottom: 2rem;
            color: white;
        }

        .quiz-map-header h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .quiz-map-header p {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .quiz-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            font-size: 1rem;
        }

        .quiz-stats strong {
            color: var(--accent-primary);
        }

        .quiz-map {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 1rem;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Individual quiz point buttons (used inside the map grid) */
        .quiz-point {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.06);
            background: rgba(255,255,255,0.03);
            color: white;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
            position: relative;
        }

        .quiz-point:hover {
            transform: translateY(-6px) scale(1.06);
            box-shadow: 0 8px 20px rgba(0,0,0,0.35);
        }

        /* Reward quiz visual treatment */
        .quiz-point.quiz-reward {
            background: linear-gradient(90deg, #FFD54F 0%, #FFC107 100%);
            color: #222;
            border: 2px solid rgba(0,0,0,0.08);
        }

        /* Small badge for reward quizzes */
        .quiz-point.quiz-reward::after {
            content: 'üèÖ';
            position: absolute;
            top: -8px;
            right: -8px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 14px;
            background: #fff8e1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Gentle pulse to draw attention on reward quizzes */
        @keyframes reward-pulse {
            0% { box-shadow: 0 0 0 0 rgba(255,193,7,0.18); }
            70% { box-shadow: 0 0 0 10px rgba(255,193,7,0.03); }
            100% { box-shadow: 0 0 0 0 rgba(255,193,7,0.0); }
        }

        .quiz-point.quiz-reward {
            animation: reward-pulse 2.8s infinite ease-in-out;
        }

        .quiz-level {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            margin: 0 auto;
        }

        .quiz-level.available {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--bg-secondary) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .quiz-level.completed {
            background: linear-gradient(135deg, var(--accent-secondary) 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .quiz-level.locked {
            background: var(--text-secondary);
            color: white;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .quiz-level:hover:not(.locked) {
            transform: scale(1.1);
        }

        .quiz-level::after {
            content: '';
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-secondary);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .quiz-level.completed::after {
            content: '‚úì';
            display: flex;
            color: white;
        }

        /* Quiz Level View */
        .quiz-level-container {
            padding: 2rem;
            overflow-y: auto;
            height: 100%;
        }

        .quiz-level-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            color: white;
        }

        .quiz-level-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .quiz-progress {
            font-size: 1rem;
            font-weight: 600;
        }

        .quiz-intro {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .quiz-intro h3 {
            color: var(--text-light);
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .quiz-intro p {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .author-citation {
            font-style: italic;
            color: var(--accent-primary);
            font-weight: 600;
        }

        .quiz-question-container {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 2rem;
        }

        .question-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .question-topic {
            background: var(--accent-primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .question-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-light);
            line-height: 1.6;
        }

        .answer-options {
            display: grid;
            gap: 1rem;
            margin-top: 2rem;
        }

        .answer-option {
            padding: 1.5rem;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .answer-option:hover {
            border-color: var(--accent-primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .answer-option.selected {
            border-color: var(--accent-primary);
            background: rgba(102, 126, 234, 0.1);
        }

        .answer-option.correct {
            border-color: var(--accent-secondary);
            background: rgba(40, 167, 69, 0.1);
        }

        .answer-option.incorrect {
            border-color: var(--house-red);
            background: rgba(220, 53, 69, 0.1);
        }

        .answer-letter {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .answer-text {
            flex: 1;
            font-size: 1rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        .feedback-container {
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 12px;
            display: none;
        }

        .feedback-container.show {
            display: block;
        }

        .feedback-container.correct {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid var(--accent-secondary);
        }

        .feedback-container.incorrect {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid var(--house-red);
        }

        .feedback-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .feedback-title.correct {
            color: var(--accent-secondary);
        }

        .feedback-title.incorrect {
            color: var(--house-red);
        }

        .feedback-text {
            color: var(--text-light);
            line-height: 1.6;
        }

        .quiz-actions {
            text-align: center;
            margin-top: 2rem;
        }

        .quiz-btn {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--bg-secondary) 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin: 0 0.5rem;
        }

        .quiz-btn:hover {
            transform: translateY(-2px);
        }

        .quiz-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .quiz-btn.secondary {
            background: var(--text-secondary);
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 0.5rem;
            }

            .user-info {
                order: -1;
            }

            .dashboard {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            .sports-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                padding: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .house-selector {
                grid-template-columns: repeat(2, 1fr);
            }

            .house-leaderboard {
                grid-template-columns: 1fr;
            }

            .avatar-display {
                width: 150px;
                height: 225px;
            }
        }

        /* Teacher Dashboard Styles */
        .teacher-dashboard {
            padding: 2rem;
            overflow-y: auto;
            height: 100%;
        }

        .teacher-header {
            color: white;
            margin-bottom: 2rem;
            text-align: center;
        }

        .teacher-header h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .teacher-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .class-selector {
            background: var(--surface-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .class-selector label {
            font-weight: 600;
            color: var(--text-light);
        }

        .class-selector select {
            padding: 0.75rem;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--surface-light);
            color: var(--text-light);
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .student-card {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        .student-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .student-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--border-light);
            overflow: hidden;
            background: var(--border-light);
        }

        .student-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .student-info h4 {
            color: var(--text-light);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .student-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .student-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .student-stat {
            text-align: center;
            padding: 0.75rem;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
        }

        .student-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .student-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .house-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: auto;
        }

        .house-indicator.red { background: var(--house-red); }
        .house-indicator.green { background: var(--house-green); }
        .house-indicator.yellow { background: var(--house-yellow); }
        .house-indicator.blue { background: var(--house-blue); }

        /* Assessment Management Styles */
        .assessment-filters {
            background: var(--surface-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .assessment-filters select {
            padding: 0.75rem;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--surface-light);
            color: var(--text-light);
            min-width: 150px;
        }

        .assessment-grid {
            display: grid;
            gap: 1.5rem;
        }

        .assessment-item {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .assessment-student-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-light);
        }

        .skills-evaluation {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .skill-input {
            padding: 1rem;
            border: 2px solid var(--border-light);
            border-radius: 12px;
        }

        .skill-input label {
            display: block;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .skill-input input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 1rem;
            text-align: center;
        }

        .skill-input input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .total-score {
            text-align: center;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
        }

        .total-score-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent-primary);
        }

        .save-assessment-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--accent-secondary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }

        .save-assessment-btn:hover {
            background: #218838;
        }

        /* Analytics Styles */
        .analytics-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .analytics-card {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .analytics-card h3 {
            color: var(--text-light);
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .class-stat {
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(0,0,0,0.05);
            border-radius: 12px;
        }

        .class-name {
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .class-average {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .class-progress {
            background: var(--border-light);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--bg-secondary) 100%);
            transition: width 0.3s ease;
        }

        .house-analytics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .house-stat {
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            color: white;
        }

        .house-stat.red { background: var(--house-red); }
        .house-stat.green { background: var(--house-green); }
        .house-stat.yellow { background: var(--house-yellow); color: #333; }
        .house-stat.blue { background: var(--house-blue); }

        .house-stat .house-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .house-stat .house-total {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .house-stat .house-students {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .completion-stats {
            display: grid;
            gap: 1rem;
        }

        .completion-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .completion-item span {
            min-width: 120px;
            font-weight: 600;
            color: var(--text-light);
        }

        .completion-bar {
            flex: 1;
            height: 24px;
            background: var(--border-light);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .completion-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--accent-secondary) 0%, #20c997 100%);
            transition: width 0.3s ease;
        }

        .completion-text {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-light);
        }

        /* Student Data Styles */
        .student-search {
            background: var(--surface-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .student-search input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--surface-light);
            color: var(--text-light);
        }

        .student-search input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .student-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }

        .student-detail-card {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .student-detail-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-light);
        }

        .student-detail-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--border-light);
            overflow: hidden;
        }

        .student-detail-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .student-progress-section {
            margin-bottom: 1.5rem;
        }

        .student-progress-section h4 {
            color: var(--text-light);
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .progress-items {
            display: grid;
            gap: 0.5rem;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: rgba(0,0,0,0.05);
            border-radius: 6px;
        }

        .progress-item-name {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .progress-item-value {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Reports Styles */
        .report-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .report-card {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .report-card h3 {
            color: var(--text-light);
            font-size: 1.3rem;
            margin-bottom: 0.75rem;
            font-weight: 700;
        }

        .report-card p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .report-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .report-controls select {
            padding: 0.75rem;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--surface-light);
            color: var(--text-light);
        }

        .report-btn {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--bg-secondary) 100%);
            color: white;
        }

        .report-btn:hover {
            transform: translateY(-2px);
        }

        .report-btn.secondary {
            background: var(--text-secondary);
        }

        .report-preview {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            min-height: 300px;
        }

        /* Responsive Design for Teacher Dashboard */
        @media (max-width: 768px) {
            .teacher-dashboard {
                padding: 1rem;
            }

            .students-grid {
                grid-template-columns: 1fr;
            }

            .analytics-cards {
                grid-template-columns: 1fr;
            }

            .house-analytics {
                grid-template-columns: 1fr;
            }

            .assessment-filters {
                flex-direction: column;
            }

            .skills-evaluation {
                grid-template-columns: 1fr;
            }

            .student-details-grid {
                grid-template-columns: 1fr;
            }

            .report-options {
                grid-template-columns: 1fr;
            }

            .class-selector {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .notification.success { background: var(--accent-secondary); }
        .notification.error { background: var(--house-red); }
        .notification.info { background: var(--accent-primary); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Authentication Screen -->
  <div id="authScreen" class="auth-container">
   <div class="auth-card">
    <h1 id="appTitle">PE Learning Hub</h1>
    <p id="welcomeMessage">Welcome to your PE Learning Journey</p><!-- User Type Selection -->
    <div class="user-type-selector">
     <div class="user-type-btn active" data-type="student">
      <div class="user-type-icon">
       üéì
      </div>
      <div class="user-type-title">
       Student
      </div>
     </div>
     <div class="user-type-btn" data-type="teacher">
      <div class="user-type-icon">
       üë®‚Äçüè´
      </div>
      <div class="user-type-title">
       Teacher
      </div>
     </div>
    </div><!-- Student Registration Form -->
    <form id="studentForm" class="auth-form">
     <div class="form-group"><label for="studentFullName">Full Name</label> <input type="text" id="studentFullName" required>
     </div>
     <div class="form-group"><label for="studentEmail">Email Address</label> <input type="email" id="studentEmail" required placeholder="student@school.edu">
     </div>
        <div class="form-group"><label for="studentPassword">Password</label> <input type="password" id="studentPassword" required placeholder="Create a password (min 6 chars)"></div>
     <div class="form-row">
      <div class="form-group"><label for="studentId">Student ID</label> <input type="text" id="studentId" required>
      </div>
      <div class="form-group"><label for="classGrade">Class/Grade</label> <select id="classGrade" required> <option value="">Select class/grade</option> <option value="Year 1C">Year 1C</option> <option value="Year 1H">Year 1H</option> <option value="Year 1I">Year 1I</option> <option value="Year 1S">Year 1S</option> <option value="Year 1J">Year 1J</option> <option value="Year 1B">Year 1B</option> <option value="Year 2C">Year 2C</option> <option value="Year 2H">Year 2H</option> <option value="Year 2I">Year 2I</option> <option value="Year 2S">Year 2S</option> <option value="Year 2J">Year 2J</option> <option value="Year 2B">Year 2B</option> <option value="Year 3C">Year 3C</option> <option value="Year 3H">Year 3H</option> <option value="Year 3I">Year 3I</option> <option value="Year 3S">Year 3S</option> <option value="Year 3J">Year 3J</option> <option value="Year 3B">Year 3B</option> <option value="Year 4C">Year 4C</option> <option value="Year 4H">Year 4H</option> <option value="Year 4I">Year 4I</option> <option value="Year 4S">Year 4S</option> <option value="Year 4J">Year 4J</option> <option value="Year 4B">Year 4B</option> <option value="Year 5C">Year 5C</option> <option value="Year 5H">Year 5H</option> <option value="Year 5I">Year 5I</option> <option value="Year 5S">Year 5S</option> <option value="Year 5J">Year 5J</option> <option value="Year 5B">Year 5B</option> <option value="Year 6C">Year 6C</option> <option value="Year 6H">Year 6H</option> <option value="Year 6I">Year 6I</option> <option value="Year 6S">Year 6S</option> <option value="Year 6J">Year 6J</option> <option value="Year 6B">Year 6B</option> <option value="Year 7C">Year 7C</option> <option value="Year 7H">Year 7H</option> <option value="Year 7I">Year 7I</option> <option value="Year 7S">Year 7S</option> <option value="Year 7J">Year 7J</option> <option value="Year 7B">Year 7B</option> <option value="Year 8C">Year 8C</option> <option value="Year 8H">Year 8H</option> <option value="Year 8I">Year 8I</option> <option value="Year 8S">Year 8S</option> <option value="Year 8J">Year 8J</option> <option value="Year 8B">Year 8B</option> <option value="Year 9C">Year 9C</option> <option value="Year 9H">Year 9H</option> <option value="Year 9I">Year 9I</option> <option value="Year 9S">Year 9S</option> <option value="Year 9J">Year 9J</option> <option value="Year 9B">Year 9B</option> <option value="Year 10C">Year 10C</option> <option value="Year 10H">Year 10H</option> <option value="Year 10I">Year 10I</option> <option value="Year 10S">Year 10S</option> <option value="Year 10J">Year 10J</option> <option value="Year 10B">Year 10B</option> <option value="Year 11C">Year 11C</option> <option value="Year 11H">Year 11H</option> <option value="Year 11I">Year 11I</option> <option value="Year 11S">Year 11S</option> <option value="Year 11J">Year 11J</option> <option value="Year 11B">Year 11B</option> <option value="Year 12C">Year 12C</option> <option value="Year 12H">Year 12H</option> <option value="Year 12I">Year 12I</option> <option value="Year 12S">Year 12S</option> <option value="Year 12J">Year 12J</option> <option value="Year 12B">Year 12B</option> <option value="Year 13C">Year 13C</option> <option value="Year 13H">Year 13H</option> <option value="Year 13I">Year 13I</option> <option value="Year 13S">Year 13S</option> <option value="Year 13J">Year 13J</option> <option value="Year 13B">Year 13B</option> </select>
      </div>
     </div>
     <div class="form-group"><label for="school">School</label> <select id="school" required> <option value="Crescendo HELP International School">Crescendo HELP International School</option> <option value="request_new">Request to Add School</option> </select>
     </div>
     <div class="form-group"><label>Profile Photo (Face must be visible)</label>
      <div class="photo-upload">
       <div class="photo-preview" id="photoPreview">
        üì∑
       </div><input type="file" id="profilePhoto" accept="image/*" style="display: none;">
       <video id="cameraPreview" style="display: none; width: 100px; height: 100px; border-radius: 50%; object-fit: cover;"></video>
       <canvas id="photoCanvas" style="display: none;"></canvas>
       <div class="photo-buttons"><button type="button" id="takePhotoBtn" class="photo-btn">üì∑ Take Photo</button> <button type="button" id="uploadBtn" class="photo-btn">üìÅ Upload Photo</button> <button type="button" id="captureBtn" class="photo-btn" style="display: none;">‚úÖ Capture</button> <button type="button" id="retakeBtn" class="photo-btn" style="display: none;">üîÑ Retake</button>
       </div>
      </div>
     </div>
     <div class="form-row">
      <div class="form-group"><label>Gender</label> <select id="gender" required> <option value="">Select gender</option> <option value="male">Male</option> <option value="female">Female</option> </select>
      </div>
      <div class="form-group"><label>House Team</label>
       <div class="house-selector">
        <div class="house-btn red" data-house="red">
         Red
        </div>
        <div class="house-btn green" data-house="green">
         Green
        </div>
        <div class="house-btn yellow" data-house="yellow">
         Yellow
        </div>
        <div class="house-btn blue" data-house="blue">
         Blue
        </div>
       </div>
      </div>
     </div><button type="submit" class="auth-btn" id="studentSubmitBtn">Create Student Account</button>
    </form><!-- Teacher Login Form -->
    <!-- Student Login Form (hidden by default) -->
    <form id="studentLoginForm" class="auth-form hidden">
     <div class="form-group"><label for="studentLoginEmail">Email Address</label> <input type="email" id="studentLoginEmail" required placeholder="student@school.edu"></div>
     <div class="form-group"><label for="studentLoginId">Student ID</label> <input type="text" id="studentLoginId" required placeholder="Enter your Student ID"></div>
        <div class="form-group"><label for="studentLoginPassword">Password</label> <input type="password" id="studentLoginPassword" required placeholder="Your password"></div>
     <button type="submit" class="auth-btn" id="studentLoginBtn">Student Login</button>
    </form>

    <div class="switch-auth" style="margin-top:1rem;">
     <button type="button" id="toStudentLoginBtn" class="photo-btn">Already have an account? Login</button>
     <button type="button" id="toStudentRegisterBtn" class="photo-btn" style="display:none;">Create Student Account</button>
    </div>

    <form id="teacherForm" class="auth-form hidden">
     <div class="form-group"><label for="teacherPrefix">Prefix</label> <select id="teacherPrefix" required> <option value="">Select prefix</option> <option value="Mr.">Mr.</option> <option value="Miss">Miss</option> </select>
     </div>
     <div class="form-group"><label for="teacherName">Full Name</label> <input type="text" id="teacherName" required>
     </div>
     <div class="form-group"><label for="teacherPassword">Password</label> <input type="password" id="teacherPassword" required> <small style="color: var(--text-secondary); font-size: 0.8rem;">First-time login: Chis1234</small>
     </div><button type="submit" class="auth-btn" id="teacherSubmitBtn">Teacher Login</button>
    </form>
   </div>
  </div><!-- Main Application -->
  <div id="appContainer" class="app-container">
   <header class="header">
    <div class="header-left">
     <h1 id="headerTitle">PE Learning Hub</h1><button class="theme-toggle" id="themeToggle">üåô</button>
    </div>
    <div class="user-info" id="userInfo">
     <div class="user-avatar" id="headerAvatar"><img src="" alt="User Avatar" id="headerAvatarImg">
     </div>
     <div class="user-details">
      <div>
       Welcome, <span id="userName"></span>
      </div>
      <div>
       <span id="userClass"></span> ‚Ä¢ <span id="userHouse"></span>
      </div>
     </div>
    </div>
    <button id="logoutBtn" class="theme-toggle" title="Logout">üîì Logout</button>
   </header>
   <nav class="nav-tabs"><button class="nav-tab active" data-tab="dashboard">üè† Dashboard</button> <button class="nav-tab" data-tab="sports">üèÉ Sports</button> <button class="nav-tab" data-tab="quiz">üß† Quiz</button> <button class="nav-tab" data-tab="leaderboard">üèÜ Leaderboard</button> <button class="nav-tab" data-tab="profile">‚öôÔ∏è Profile</button>
   </nav>
   <main class="main-content"><!-- Dashboard Tab -->
    <div id="dashboardTab" class="dashboard"><!-- Avatar & Level Section -->
     <div class="dashboard-card">
      <h3>Your Avatar</h3>
      <div class="avatar-section">
       <div class="avatar-display">
        <div class="avatar-body" id="avatarBody">
         üí™
        </div>
        <div class="avatar-head" id="avatarHead"><img src="" alt="Avatar Head" id="avatarHeadImg">
        </div>
       </div>
       <div class="level-info">
        <div class="level-badge">
         Level <span id="avatarLevel">1</span>
        </div>
        <div class="house-points">
         <span id="housePointsDisplay">0</span> House Points
        </div>
       </div>
      </div>
     </div><!-- Overall Progress -->
     <div class="dashboard-card">
      <h3>Overall Progress</h3>
      <div class="progress-ring">
       <svg width="120" height="120"><circle class="bg" cx="60" cy="60" r="52" stroke-dasharray="326.73" stroke-dashoffset="0"></circle> <circle class="progress" cx="60" cy="60" r="52" stroke-dasharray="326.73" stroke-dashoffset="326.73" id="overallProgress"></circle>
       </svg>
       <div class="progress-text" id="overallProgressText">
        0%
       </div>
      </div>
      <div class="stats-grid">
       <div class="stat-item">
        <div class="stat-value" id="completedSports">
         0
        </div>
        <div class="stat-label">
         Sports Completed
        </div>
       </div>
       <div class="stat-item">
        <div class="stat-value" id="completedQuizzes">
         0
        </div>
        <div class="stat-label">
         Quizzes Completed
        </div>
       </div>
      </div>
     </div>
     <!-- House Standings removed from dashboard by request -->
     <!-- Recent Activity -->
     <div class="dashboard-card">
      <h3>Recent Activity</h3>
      <div id="recentActivity">
       <div class="stat-item">
        <div class="stat-value">
         üèÄ
        </div>
        <div class="stat-label">
         Basketball Assessment Completed
        </div>
       </div>
       <div class="stat-item">
        <div class="stat-value">
         üß†
        </div>
        <div class="stat-label">
         Quiz Level 5 Completed
        </div>
       </div>
      </div>
     </div>
    </div><!-- Sports Tab -->
    <div id="sportsTab" class="sports-grid hidden"><!-- Sports will be dynamically loaded here -->
    </div><!-- Sport Detail View -->
    <div id="sportDetailView" class="hidden">
     <div class="sport-detail-container">
      <div class="sport-detail-header"><button class="back-btn" id="backToSports">‚Üê Back to Sports</button>
       <h2 id="sportDetailTitle">Basketball</h2>
      </div>
      <div class="lesson-grid" id="lessonGrid"><!-- Lessons 1-10 + Skills + History will be loaded here -->
      </div>
     </div>
    </div><!-- Lesson Detail View -->
    <div id="lessonDetailView" class="hidden">
     <div class="lesson-container">
      <div class="lesson-header"><button class="back-btn" id="backToSport">‚Üê Back to Sport</button>
       <h2 id="lessonTitle">Lesson 1: Assessment</h2>
      </div>
      <div class="lesson-content" id="lessonContent"><!-- Lesson content will be loaded here -->
      </div>
     </div>
    </div><!-- Assessment View -->
    <div id="assessmentView" class="hidden">
     <div class="assessment-container">
      <div class="assessment-header"><button class="back-btn" id="backToLesson">‚Üê Back to Lesson</button>
       <h2 id="assessmentTitle">Self-Assessment</h2>
       <p id="assessmentSubtitle">Rate your current skill level</p>
      </div>
      <div class="assessment-content" id="assessmentContent"><!-- Assessment skills will be loaded here -->
      </div>
      <div class="assessment-actions"><button class="assessment-btn" id="saveAssessment">Save Assessment</button>
      </div>
     </div>
    </div><!-- Skills View (Teacher Only) -->
    <div id="skillsView" class="hidden">
     <div class="skills-container">
      <div class="skills-header"><button class="back-btn" id="backToSportFromSkills">‚Üê Back to Sport</button>
       <h2>Skills Assessment</h2>
       <p>Teacher evaluation - Awards house points (0-20)</p>
      </div>
      <div class="skills-content" id="skillsContent"><!-- Skills evaluation will be loaded here -->
      </div>
     </div>
    </div><!-- Sport History View -->
    <div id="sportHistoryView" class="hidden">
     <div class="history-container">
      <div class="history-header"><button class="back-btn" id="backToSportFromHistory">‚Üê Back to Sport</button>
       <h2 id="historyTitle">Basketball History</h2>
      </div>
      <div class="history-content" id="historyContent"><!-- History content and quiz will be loaded here -->
      </div>
     </div>
    </div><!-- Quiz Tab -->
    <div id="quizTab" class="quiz-map-container hidden">
     <div class="quiz-map-header">
      <h2>PE Knowledge Quest</h2>
      <p>100 levels of PE mastery - Candy Crush style progression!</p>
      <div class="quiz-stats"><span>Level: <strong id="currentQuizLevel">1</strong></span> <span>Completed: <strong id="completedQuizLevels">0</strong>/100</span>
      </div>
     </div>
     <div class="quiz-map" id="quizMap"><!-- Quiz levels will be dynamically loaded here -->
     </div>
    </div><!-- Quiz Level View -->
    <div id="quizLevelView" class="hidden">
     <div class="quiz-level-container">
      <div class="quiz-level-header"><button class="back-btn" id="backToQuizMap">‚Üê Back to Map</button>
       <h2 id="quizLevelTitle">Level 1 Quiz</h2>
       <div class="quiz-progress"><span>Question <span id="currentQuestionNum">1</span> of 10</span>
       </div>
      </div>
      <div class="quiz-intro" id="quizIntro"><!-- Quiz introduction and author citation -->
      </div>
      <div class="quiz-question-container" id="quizQuestionContainer"><!-- Quiz questions will be loaded here -->
      </div>
     </div>
    </div><!-- Leaderboard Tab -->
    <div id="leaderboardTab" class="hidden">
     <div style="padding: 2rem; color: white;">
      <h2>Leaderboard</h2>
      <p>Class and school-wide rankings coming soon!</p>
     </div>
    </div><!-- Profile Tab -->
    <div id="profileTab" class="hidden">
     <div style="padding: 2rem; color: white;">
      <h2>Profile Settings</h2>
      <p>Manage your account settings and preferences.</p>
     </div>
    </div>
   </main>
  </div>
  <script>
        // Configuration and Data
        const defaultConfig = {
            app_title: "PE Learning Hub",
            welcome_message: "Welcome to your PE Learning Journey",
            school_name: "Crescendo HELP International School",
            background_color: "#667eea",
            surface_color: "#ffffff",
            text_color: "#1a1a1a",
            primary_action_color: "#667eea",
            secondary_action_color: "#28a745"
        };

        // Modular Sports Architecture - Each sport as independent module
        const SPORTS_MODULES = {
            basketball: {
                name: "Basketball",
                icon: "üèÄ",
                keyStage: "all",
                equipment: ["Basketball", "Hoop", "Court"],
                skills: ["Dribbling", "Shooting", "Passing", "Defense"],
                contentVersion: "1.0",
                lessons: {
                    2: { title: "Dribbling Basics", content: "basketball_lesson_2.json" },
                    3: { title: "Shooting Technique", content: "basketball_lesson_3.json" },
                    4: { title: "Passing Skills", content: "basketball_lesson_4.json" },
                    6: { title: "Defensive Positioning", content: "basketball_lesson_6.json" },
                    7: { title: "Game Strategy", content: "basketball_lesson_7.json" },
                    8: { title: "Team Play", content: "basketball_lesson_8.json" }
                },
                skillsAssessment: "basketball_skills.json",
                historyQuiz: "basketball_history.json"
            },
            football: {
                name: "Football",
                icon: "‚öΩ",
                keyStage: "all",
                equipment: ["Football", "Goals", "Pitch"],
                skills: ["Ball Control", "Passing", "Shooting", "Tackling"],
                contentVersion: "1.0",
                lessons: {
                    2: { title: "Ball Control", content: "football_lesson_2.json" },
                    3: { title: "Passing Accuracy", content: "football_lesson_3.json" },
                    4: { title: "Shooting Power", content: "football_lesson_4.json" },
                    6: { title: "Defensive Skills", content: "football_lesson_6.json" },
                    7: { title: "Tactical Awareness", content: "football_lesson_7.json" },
                    8: { title: "Match Play", content: "football_lesson_8.json" }
                },
                skillsAssessment: "football_skills.json",
                historyQuiz: "football_history.json"
            },
            handball: {
                name: "Handball",
                icon: "ü§æ",
                keyStage: "KS2+",
                equipment: ["Handball", "Goals", "Court"],
                skills: ["Throwing", "Catching", "Jumping", "Blocking"],
                contentVersion: "1.0",
                lessons: {
                    2: { title: "Basic Throwing", content: "handball_lesson_2.json" },
                    3: { title: "Catching Techniques", content: "handball_lesson_3.json" },
                    4: { title: "Goal Shooting", content: "handball_lesson_4.json" },
                    6: { title: "Defensive Play", content: "handball_lesson_6.json" },
                    7: { title: "Team Tactics", content: "handball_lesson_7.json" },
                    8: { title: "Fast Break", content: "handball_lesson_8.json" }
                },
                skillsAssessment: "handball_skills.json",
                historyQuiz: "handball_history.json"
            },
            rugby: {
                name: "Rugby",
                icon: "üèâ",
                keyStage: "KS2+",
                equipment: ["Rugby Ball", "Pitch"],
                skills: ["Passing", "Tackling", "Rucking"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Passing Basics", content: "rugby_lesson_2.json" } },
                skillsAssessment: "rugby_skills.json",
                historyQuiz: "rugby_history.json"
            },
            ultimate_frisbee: {
                name: "Ultimate Frisbee",
                icon: "ü•è",
                keyStage: "KS2+",
                equipment: ["Frisbee", "Field"],
                skills: ["Throwing", "Catching", "Cutting"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Throwing Basics", content: "ultimate_lesson_2.json" } },
                skillsAssessment: "ultimate_skills.json",
                historyQuiz: "ultimate_history.json"
            },
            hockey: {
                name: "Hockey",
                icon: "üèí",
                keyStage: "KS2+",
                equipment: ["Stick", "Ball/Puck", "Pitch"],
                skills: ["Dribbling", "Passing", "Shooting"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Dribbling", content: "hockey_lesson_2.json" } },
                skillsAssessment: "hockey_skills.json",
                historyQuiz: "hockey_history.json"
            },
            baseball: {
                name: "Baseball",
                icon: "‚öæ",
                keyStage: "KS2+",
                equipment: ["Bat", "Ball", "Glove"],
                skills: ["Batting", "Fielding", "Throwing"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Batting Basics", content: "baseball_lesson_2.json" } },
                skillsAssessment: "baseball_skills.json",
                historyQuiz: "baseball_history.json"
            },
            netball: {
                name: "Netball",
                icon: "üèê",
                keyStage: "KS2+",
                equipment: ["Ball", "Court"],
                skills: ["Passing", "Shooting", "Positioning"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Passing", content: "netball_lesson_2.json" } },
                skillsAssessment: "netball_skills.json",
                historyQuiz: "netball_history.json"
            },
            swimming_distance: {
                name: "Swimming (Distance)",
                icon: "üèä‚Äç‚ôÇÔ∏è",
                keyStage: "KS1+",
                equipment: ["Pool"],
                skills: ["Endurance", "Stroke Efficiency"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Endurance Training", content: "swim_distance_lesson_2.json" } },
                skillsAssessment: "swim_distance_skills.json",
                historyQuiz: "swimming_distance_history.json"
            },
            swimming_speed: {
                name: "Swimming (Speed)",
                icon: "üèä‚Äç‚ôÄÔ∏è",
                keyStage: "KS1+",
                equipment: ["Pool"],
                skills: ["Sprint Technique", "Starts", "Turns"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Sprint Technique", content: "swim_speed_lesson_2.json" } },
                skillsAssessment: "swim_speed_skills.json",
                historyQuiz: "swimming_speed_history.json"
            },
            orienteering: {
                name: "Orienteering",
                icon: "üß≠",
                keyStage: "KS2+",
                equipment: ["Map", "Compass"],
                skills: ["Navigation", "Decision Making"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Map Reading", content: "orienteering_lesson_2.json" } },
                skillsAssessment: "orienteering_skills.json",
                historyQuiz: "orienteering_history.json"
            },
            athletics: {
                name: "Athletics",
                icon: "üéΩ",
                keyStage: "KS2+",
                equipment: ["Track", "Field"],
                skills: ["Running", "Jumping", "Throwing"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Track Basics", content: "athletics_lesson_2.json" } },
                skillsAssessment: "athletics_skills.json",
                historyQuiz: "athletics_history.json"
            },
            running_distance: {
                name: "Running (Distance)",
                icon: "üèÉ‚Äç‚ôÇÔ∏è",
                keyStage: "KS1+",
                equipment: ["Track"],
                skills: ["Pacing", "Endurance"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Distance Pacing", content: "running_distance_lesson_2.json" } },
                skillsAssessment: "running_distance_skills.json",
                historyQuiz: "running_distance_history.json"
            },
            gym: {
                name: "Gym",
                icon: "üèãÔ∏è‚Äç‚ôÇÔ∏è",
                keyStage: "KS2+",
                equipment: ["Machines", "Weights"],
                skills: ["Strength", "Technique"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Gym Safety", content: "gym_lesson_2.json" } },
                skillsAssessment: "gym_skills.json",
                historyQuiz: "gym_history.json"
            },
            bodyweight_training: {
                name: "Bodyweight Training",
                icon: "ü§∏",
                keyStage: "KS2+",
                equipment: [],
                skills: ["Core Strength", "Mobility"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Calisthenics Basics", content: "bodyweight_lesson_2.json" } },
                skillsAssessment: "bodyweight_skills.json",
                historyQuiz: "bodyweight_history.json"
            },
            contemporary_dance: {
                name: "Contemporary Dance",
                icon: "üíÉ",
                keyStage: "KS1+",
                equipment: [],
                skills: ["Expression", "Technique"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Movement Basics", content: "dance_lesson_2.json" } },
                skillsAssessment: "dance_skills.json",
                historyQuiz: "dance_history.json"
            },
            gymnastics: {
                name: "Gymnastics",
                icon: "ü§∏‚Äç‚ôÄÔ∏è",
                keyStage: "KS1+",
                equipment: ["Mats", "Apparatus"],
                skills: ["Balance", "Flexibility", "Strength"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Balance Basics", content: "gymnastics_lesson_2.json" } },
                skillsAssessment: "gymnastics_skills.json",
                historyQuiz: "gymnastics_history.json"
            },
            table_tennis: {
                name: "Table Tennis",
                icon: "üèì",
                keyStage: "KS2+",
                equipment: ["Racket", "Ball", "Table"],
                skills: ["Serve", "Return", "Spin"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Serve Basics", content: "table_tennis_lesson_2.json" } },
                skillsAssessment: "table_tennis_skills.json",
                historyQuiz: "table_tennis_history.json"
            },
            badminton: {
                name: "Badminton",
                icon: "üè∏",
                keyStage: "KS2+",
                equipment: ["Racket", "Shuttlecock"],
                skills: ["Serve", "Smash", "Footwork"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Serve", content: "badminton_lesson_2.json" } },
                skillsAssessment: "badminton_skills.json",
                historyQuiz: "badminton_history.json"
            },
            boxing: {
                name: "Boxing",
                icon: "ü•ä",
                keyStage: "KS3+",
                equipment: ["Gloves", "Bag"],
                skills: ["Punching", "Defense", "Footwork"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Stance and Footwork", content: "boxing_lesson_2.json" } },
                skillsAssessment: "boxing_skills.json",
                historyQuiz: "boxing_history.json"
            },
            judo: {
                name: "Judo",
                icon: "ü•ã",
                keyStage: "KS3+",
                equipment: ["Mat", "Gi"],
                skills: ["Throwing", "Grappling", "Breakfalls"],
                contentVersion: "1.0",
                lessons: { 2: { title: "Breakfalls", content: "judo_lesson_2.json" } },
                skillsAssessment: "judo_skills.json",
                historyQuiz: "judo_history.json"
            }
        };

        // Legacy compatibility - convert to old format for existing code
        const SPORTS_DATA = Object.fromEntries(
            Object.entries(SPORTS_MODULES).map(([key, module]) => [
                key, { name: module.name, icon: module.icon }
            ])
        );

        // Lesson Structure
        const LESSON_STRUCTURE = {
            1: { type: 'assessment', title: 'Initial Assessment', description: 'Self-assessment of current skills' },
            2: { type: 'practice', title: 'Basic Techniques', description: 'Fundamental motor skills' },
            3: { type: 'practice', title: 'Skill Development', description: 'Building core competencies' },
            4: { type: 'practice', title: 'Applied Practice', description: 'Practical skill application' },
            5: { type: 'assessment', title: 'Mid-Point Assessment', description: 'Progress evaluation' },
            6: { type: 'practice', title: 'Advanced Techniques', description: 'Complex motor patterns' },
            7: { type: 'practice', title: 'Strategy & Tactics', description: 'Game understanding' },
            8: { type: 'practice', title: 'Performance Skills', description: 'Competitive application' },
            9: { type: 'assessment', title: 'Pre-Final Assessment', description: 'Comprehensive evaluation' },
            10: { type: 'assessment', title: 'Final Assessment', description: 'Complete skill demonstration' },
            11: { type: 'skills', title: 'SKILLS', description: 'Teacher evaluation (0-20 points)' },
            12: { type: 'history', title: 'Sport History', description: 'Origins and evolution + Quiz' }
        };

        // Assessment Skills Structure
        const ASSESSMENT_SKILLS = {
            motor1: {
                title: "Movement Coordination",
                description: "Ability to coordinate body movements effectively and efficiently",
                type: "motor"
            },
            motor2: {
                title: "Technical Execution",
                description: "Precision and accuracy in performing sport-specific techniques",
                type: "motor"
            },
            motor3: {
                title: "Physical Control",
                description: "Balance, stability, and body control during activities",
                type: "motor"
            },
            methodology: {
                title: "Understanding & Application",
                description: "Knowledge of rules, strategies, and tactical awareness",
                type: "methodology"
            },
            social: {
                title: "Teamwork & Communication",
                description: "Collaboration, leadership, and positive interaction with others",
                type: "social"
            }
        };

        // Skill Levels
        const SKILL_LEVELS = {
            1: { name: "Beginner", description: "Just starting to learn the basics" },
            2: { name: "Explorer", description: "Developing understanding and trying new skills" },
            3: { name: "Performer", description: "Confident execution with good technique" },
            4: { name: "Champion", description: "Excellent mastery and leadership qualities" }
        };

        // Quiz Topics
        const QUIZ_TOPICS = [
            "Foundations of Health",
            "Strong Body, Strong Mind", 
            "Fuel & Nutrition",
            "Teamwork Counts",
            "Values in Sport",
            "Olympic Journey",
            "Know Your Body",
            "Safe Moves",
            "Fair Play First",
            "PE in Society"
        ];

        // Sample Quiz Questions
        const SAMPLE_QUIZ_QUESTIONS = {
            "Foundations of Health": [
                {
                    question: "What are the main components of physical fitness?",
                    options: ["Strength, Speed, Flexibility", "Cardiovascular endurance, Muscular strength, Flexibility, Body composition", "Running, Jumping, Throwing", "Diet, Exercise, Sleep"],
                    correct: 1,
                    explanation: "Physical fitness includes cardiovascular endurance, muscular strength, muscular endurance, flexibility, and body composition."
                }
            ],
            "Strong Body, Strong Mind": [
                {
                    question: "How does regular exercise benefit mental health?",
                    options: ["Only improves physical appearance", "Reduces stress and improves mood through endorphin release", "Has no effect on mental health", "Only helps with sleep"],
                    correct: 1,
                    explanation: "Exercise releases endorphins, reduces stress hormones, and improves overall mental wellbeing and cognitive function."
                }
            ],
            "Fuel & Nutrition": [
                {
                    question: "What is the best time to eat before exercising?",
                    options: ["Immediately before exercise", "2-3 hours before for a large meal, 30-60 minutes for a snack", "Never eat before exercise", "Only after exercise"],
                    correct: 1,
                    explanation: "Proper timing allows for digestion while providing energy for performance. Large meals need more time to digest."
                }
            ]
        };

        // Key Stage Classification
        const KEY_STAGES = {
            'Year 1': 'KS1', 'Year 2': 'KS1',
            'Year 3': 'KS2', 'Year 4': 'KS2',
            'Year 5': 'KS2_plus', 'Year 6': 'KS2_plus',
            'Year 7': 'KS3', 'Year 8': 'KS3', 'Year 9': 'KS3',
            'Year 10': 'KS4', 'Year 11': 'KS4',
            'Year 12': 'KS5', 'Year 13': 'KS5'
        };

        // Application State
        let currentUser = null;
        let currentView = 'dashboard';
        let currentUserType = 'student';
        let selectedHouse = null;
        let profilePhotoData = null;
        let userData = [];
        let isDarkMode = false;
        let currentSport = null;
        let currentLesson = null;
        let currentAssessment = {};
        let currentQuizLevel = 1;
        let currentQuizQuestion = 0;
        let quizQuestions = [];
        let quizAnswers = [];
        let completedQuizLevels = [];
        let cameraStream = null;
        let isCameraActive = false;

        // Data SDK Handler
        const dataHandler = {
            onDataChanged(data) {
                userData = data;
                if (currentUser) {
                    updateDashboard();
                }
            }
        };

        // Content Management System - Database structure with versioning
        const CONTENT_MANAGER = {
            version: "1.0.0",
            lastUpdated: new Date().toISOString(),
            
            // Load lesson content dynamically (no hardcoded content in main codebase)
            async loadLessonContent(sport, lessonNumber) {
                try {
                    // In production, this would fetch from Firebase/database
                    const contentPath = SPORTS_MODULES[sport]?.lessons[lessonNumber]?.content;
                    if (!contentPath) {
                        return this.getDefaultLessonContent(sport, lessonNumber);
                    }
                    
                    // Simulate API call - in production would be: fetch(`/api/content/${contentPath}`)
                    return this.getDefaultLessonContent(sport, lessonNumber);
                } catch (error) {
                    console.error('Failed to load lesson content:', error);
                    return this.getDefaultLessonContent(sport, lessonNumber);
                }
            },
            
            // Load skills assessment data
            async loadSkillsAssessment(sport) {
                try {
                    const assessmentPath = SPORTS_MODULES[sport]?.skillsAssessment;
                    // In production: fetch(`/api/assessments/${assessmentPath}`)
                    return this.getDefaultSkillsAssessment(sport);
                } catch (error) {
                    console.error('Failed to load skills assessment:', error);
                    return this.getDefaultSkillsAssessment(sport);
                }
            },
            
            // Load quiz questions
            async loadQuizQuestions(level) {
                try {
                    // In production: fetch(`/api/quiz/level/${level}`)
                    return this.getDefaultQuizQuestions(level);
                } catch (error) {
                    console.error('Failed to load quiz questions:', error);
                    return this.getDefaultQuizQuestions(level);
                }
            },
            
            // Default content generators (fallbacks)
            getDefaultLessonContent(sport, lessonNumber) {
                const sportModule = SPORTS_MODULES[sport];
                const lessonTitle = sportModule?.lessons[lessonNumber]?.title || `Lesson ${lessonNumber}`;
                
                return {
                    title: lessonTitle,
                    objectives: [`Master ${sportModule?.skills[0] || 'basic skills'}`, "Improve technique", "Build confidence"],
                    activities: [
                        { name: "Warm-up", duration: "10 mins", description: "Dynamic stretching and light movement" },
                        { name: "Skill Practice", duration: "20 mins", description: `Focus on ${lessonTitle.toLowerCase()}` },
                        { name: "Game Application", duration: "15 mins", description: "Apply skills in game-like situations" },
                        { name: "Cool-down", duration: "5 mins", description: "Static stretching and reflection" }
                    ],
                    equipment: sportModule?.equipment || ["Basic equipment"],
                    safetyNotes: ["Check equipment before use", "Maintain safe distances", "Follow teacher instructions"],
                    version: "1.0"
                };
            },
            
            getDefaultSkillsAssessment(sport) {
                return {
                    sport: sport,
                    skills: [
                        { name: "Motor Skill 1", maxPoints: 4, criteria: "Coordination and control" },
                        { name: "Motor Skill 2", maxPoints: 4, criteria: "Technique execution" },
                        { name: "Motor Skill 3", maxPoints: 4, criteria: "Physical application" },
                        { name: "Methodology", maxPoints: 4, criteria: "Understanding and strategy" },
                        { name: "Social Skills", maxPoints: 4, criteria: "Teamwork and communication" }
                    ],
                    totalPoints: 20,
                    version: "1.0"
                };
            },
            
            getDefaultQuizQuestions(level) {
                const topicIndex = (level - 1) % QUIZ_TOPICS.length;
                const topic = QUIZ_TOPICS[topicIndex];
                
                return Array.from({ length: 10 }, (_, i) => ({
                    id: `${level}_${i + 1}`,
                    topic: topic,
                    question: `Question ${i + 1} about ${topic}`,
                    options: [
                        "Option A - Basic understanding",
                        "Option B - Intermediate knowledge",
                        "Option C - Advanced application",
                        "Option D - Expert mastery"
                    ],
                    correct: Math.floor(Math.random() * 4),
                    explanation: `This tests your knowledge of ${topic} concepts.`,
                    difficulty: Math.min(Math.floor(level / 10) + 1, 5),
                    version: "1.0"
                }));
            }
        };

        // Initialize Application
        async function initializeApp() {
            // Initialize theme first for immediate visual feedback
            initializeTheme();
            
            // Initialize Data SDK
            if (window.dataSdk) {
                const initResult = await window.dataSdk.init(dataHandler);
                if (!initResult.isOk) {
                    console.error("Failed to initialize data SDK");
                }
            }

            // Initialize Element SDK
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig,
                    onConfigChange,
                    mapToCapabilities: (config) => ({
                        recolorables: [
                            {
                                get: () => config.background_color || defaultConfig.background_color,
                                set: (value) => {
                                    config.background_color = value;
                                    window.elementSdk.setConfig({ background_color: value });
                                }
                            },
                            {
                                get: () => config.surface_color || defaultConfig.surface_color,
                                set: (value) => {
                                    config.surface_color = value;
                                    window.elementSdk.setConfig({ surface_color: value });
                                }
                            },
                            {
                                get: () => config.text_color || defaultConfig.text_color,
                                set: (value) => {
                                    config.text_color = value;
                                    window.elementSdk.setConfig({ text_color: value });
                                }
                            },
                            {
                                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                                set: (value) => {
                                    config.primary_action_color = value;
                                    window.elementSdk.setConfig({ primary_action_color: value });
                                }
                            },
                            {
                                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                                set: (value) => {
                                    config.secondary_action_color = value;
                                    window.elementSdk.setConfig({ secondary_action_color: value });
                                }
                            }
                        ],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["app_title", config.app_title || defaultConfig.app_title],
                        ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
                        ["school_name", config.school_name || defaultConfig.school_name]
                    ])
                });
            }

            setupEventListeners();
            checkExistingUser();
        }

        async function onConfigChange(config) {
            const appTitle = config.app_title || defaultConfig.app_title;
            const welcomeMessage = config.welcome_message || defaultConfig.welcome_message;
            const schoolName = config.school_name || defaultConfig.school_name;

            document.getElementById('appTitle').textContent = appTitle;
            document.getElementById('headerTitle').textContent = appTitle;
            document.getElementById('welcomeMessage').textContent = welcomeMessage;
            
            // Update school option
            const schoolSelect = document.getElementById('school');
            if (schoolSelect.options[0]) {
                schoolSelect.options[0].textContent = schoolName;
                schoolSelect.options[0].value = schoolName;
            }
        }

        function setupEventListeners() {
            // User type selection
            document.querySelectorAll('.user-type-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.user-type-btn').forEach(b => b.classList.remove('active'));
                    e.target.closest('.user-type-btn').classList.add('active');
                    currentUserType = e.target.closest('.user-type-btn').dataset.type;
                    toggleAuthForms();
                });
            });

            // Photo upload and camera
            document.getElementById('uploadBtn').addEventListener('click', () => {
                document.getElementById('profilePhoto').click();
            });

            document.getElementById('takePhotoBtn').addEventListener('click', startCamera);
            document.getElementById('captureBtn').addEventListener('click', capturePhoto);
            document.getElementById('retakeBtn').addEventListener('click', retakePhoto);

            document.getElementById('profilePhoto').addEventListener('change', handlePhotoUpload);

            // House selection
            document.querySelectorAll('.house-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.house-btn').forEach(b => b.classList.remove('selected'));
                    e.target.classList.add('selected');
                    selectedHouse = e.target.dataset.house;
                });
            });

            // Form submissions
            document.getElementById('studentForm').addEventListener('submit', handleStudentRegistration);
            document.getElementById('teacherForm').addEventListener('submit', handleTeacherLogin);

            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Logout button (returns to inscription/registration menu)
            const logoutEl = document.getElementById('logoutBtn');
            if (logoutEl) logoutEl.addEventListener('click', logout);

            // Sports navigation
            document.getElementById('backToSports').addEventListener('click', () => switchTab('sports'));
            document.getElementById('backToSport').addEventListener('click', showSportDetail);
            document.getElementById('backToLesson').addEventListener('click', showLessonDetail);
            document.getElementById('backToSportFromSkills').addEventListener('click', showSportDetail);
            document.getElementById('backToSportFromHistory').addEventListener('click', showSportDetail);

            // Assessment
            document.getElementById('saveAssessment').addEventListener('click', saveAssessment);

            // Quiz navigation
            document.getElementById('backToQuizMap').addEventListener('click', () => switchTab('quiz'));
        }

        function toggleAuthForms() {
            const studentForm = document.getElementById('studentForm');
            const teacherForm = document.getElementById('teacherForm');
            
            if (currentUserType === 'student') {
                studentForm.classList.remove('hidden');
                teacherForm.classList.add('hidden');
            } else {
                studentForm.classList.add('hidden');
                teacherForm.classList.remove('hidden');
            }
        }

        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    profilePhotoData = e.target.result;
                    const preview = document.getElementById('photoPreview');
                    preview.innerHTML = `<img src="${profilePhotoData}" alt="Profile Photo">`;
                    resetCameraUI();
                };
                reader.readAsDataURL(file);
            }
        }

        async function startCamera() {
            try {
                // Stop any existing camera stream
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }

                // Request camera access
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user' // Front-facing camera
                    } 
                });

                const video = document.getElementById('cameraPreview');
                const preview = document.getElementById('photoPreview');
                
                video.srcObject = cameraStream;
                video.play();
                
                // Show camera preview and hide photo preview
                video.style.display = 'block';
                preview.style.display = 'none';
                
                // Update button visibility
                document.getElementById('takePhotoBtn').style.display = 'none';
                document.getElementById('uploadBtn').style.display = 'none';
                document.getElementById('captureBtn').style.display = 'inline-block';
                document.getElementById('retakeBtn').style.display = 'inline-block';
                
                isCameraActive = true;
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                showNotification('Camera access denied or not available. Please use upload instead.', 'error');
            }
        }

        function capturePhoto() {
            if (!cameraStream || !isCameraActive) return;

            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('photoCanvas');
            const preview = document.getElementById('photoPreview');
            
            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to data URL
            profilePhotoData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Update preview
            preview.innerHTML = `<img src="${profilePhotoData}" alt="Captured Photo">`;
            preview.style.display = 'flex';
            
            // Stop camera and hide video
            stopCamera();
            
            showNotification('Photo captured successfully!', 'success');
        }

        function retakePhoto() {
            if (isCameraActive) {
                // If camera is active, just restart it
                startCamera();
            } else {
                // If camera is not active, start it fresh
                resetCameraUI();
                startCamera();
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            const video = document.getElementById('cameraPreview');
            video.style.display = 'none';
            video.srcObject = null;
            
            isCameraActive = false;
            resetCameraUI();
        }

        function resetCameraUI() {
            // Reset button visibility
            document.getElementById('takePhotoBtn').style.display = 'inline-block';
            document.getElementById('uploadBtn').style.display = 'inline-block';
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'none';
            
            // Show photo preview
            document.getElementById('photoPreview').style.display = 'flex';
        }

        async function handleStudentRegistration(e) {
            e.preventDefault();
            console.log('[registration] starting student registration');
            
            if (!selectedHouse) {
                showNotification('Please select a house team', 'error');
                return;
            }

            if (!profilePhotoData) {
                showNotification('Please upload or take a profile photo', 'error');
                return;
            }

            // Stop camera if active
            if (isCameraActive) {
                stopCamera();
            }

            const submitBtn = document.getElementById('studentSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating Account...';

            // basic password validation
            const pwdEl = document.getElementById('studentPassword');
            const pwdVal = pwdEl ? (pwdEl.value || '') : '';
            if (!pwdVal || pwdVal.length < 6) {
                showNotification('Password must be at least 6 characters long', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Student Account';
                return;
            }

            const formData = {
                user_type: 'student',
                full_name: document.getElementById('studentFullName').value,
                fullName: document.getElementById('studentFullName').value,
                email: document.getElementById('studentEmail').value,
                student_id: document.getElementById('studentId').value,
                studentId: document.getElementById('studentId').value,
                password: document.getElementById('studentPassword') ? document.getElementById('studentPassword').value : undefined,
                class_grade: document.getElementById('classGrade').value,
                school: document.getElementById('school').value,
                house_team: selectedHouse,
                profile_photo: profilePhotoData,
                gender: document.getElementById('gender').value,
                avatar_level: 1,
                house_points: 0,
                sport_progress: JSON.stringify({}),
                quiz_progress: JSON.stringify({ currentLevel: 1, completed: [] }),
                achievements: JSON.stringify(['Getting Started']),
                assessment_data: JSON.stringify({}),
                dark_mode: false,
                created_at: new Date().toISOString(),
                last_login: new Date().toISOString()
            };

            // Check if user already exists
            const existingUser = userData.find(user => 
                user.student_id === formData.student_id || user.email === formData.email
            );
            if (existingUser) {
                const duplicateField = existingUser.student_id === formData.student_id ? 'Student ID' : 'Email address';
                showNotification(`${duplicateField} already exists`, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Student Account';
                return;
            }

            // Try to create via dataSdk (Firestore or LocalStorage)
            let creationSuccess = false;
            if (window.dataSdk) {
                try {
                    const result = await window.dataSdk.create({
                        user_id: formData.student_id,
                        ...formData
                    });

                    if (result && result.isOk) {
                        console.log('[registration] dataSdk.create succeeded');
                        creationSuccess = true;
                    } else {
                        console.warn('[registration] dataSdk.create returned non-OK', result);
                    }
                } catch (err) {
                    console.error('[registration] dataSdk.create error:', err);
                }
            } else {
                console.warn('[registration] window.dataSdk not available');
            }

            // Fallback: if SDK creation failed or SDK missing, create locally
            if (!creationSuccess) {
                console.log('[registration] using local fallback for account creation');
                currentUser = formData;
                // Ensure userData is an array (local variable takes precedence)
                if (!Array.isArray(userData)) {
                    userData = [];
                }
                // Ensure aliases for login compatibility
                if (!formData.studentId && formData.student_id) formData.studentId = formData.student_id;
                if (!formData.fullName && formData.full_name) formData.fullName = formData.full_name;
                userData.push(formData);
                // Also sync to window and localStorage
                window.userData = userData;
                localStorage.setItem('peHubUser', JSON.stringify(currentUser));
                localStorage.setItem('peHubUsers', JSON.stringify(userData));
                // also save under generic `users` key used by login
                localStorage.setItem('users', JSON.stringify(userData));
                console.log('[registration] account saved to localStorage and userData array');
            } else {
                currentUser = formData;
                localStorage.setItem('peHubUser', JSON.stringify(currentUser));
                // if SDK worked, also mirror to users key locally
                try {
                    const existing = JSON.parse(localStorage.getItem('users') || '[]');
                    existing.push(formData);
                    localStorage.setItem('users', JSON.stringify(existing));
                } catch (err) {}
            }

            showMainApp();
            showNotification('Account created successfully!', 'success');
            console.log('[registration] registration complete, showing main app');

            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Student Account';
        }

        async function handleTeacherLogin(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('teacherSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Logging in...';

            const prefix = document.getElementById('teacherPrefix').value;
            const name = document.getElementById('teacherName').value;
            const password = document.getElementById('teacherPassword').value;

            // Check for first-time login
            if (password === 'Chis1234') {
                showNotification('Please change your password after first login', 'info');
                // In a real app, this would redirect to password change
            }

            // For demo purposes, accept any teacher login
            const teacherData = {
                user_type: 'teacher',
                full_name: `${prefix} ${name}`,
                teacher_password: password,
                password_changed: password !== 'Chis1234',
                dark_mode: false,
                created_at: new Date().toISOString(),
                last_login: new Date().toISOString()
            };

            currentUser = teacherData;
            localStorage.setItem('peHubUser', JSON.stringify(currentUser));
            showTeacherDashboard();
            showNotification('Teacher login successful!', 'success');

            submitBtn.disabled = false;
            submitBtn.textContent = 'Teacher Login';
        }

        function showTeacherDashboard() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('appContainer').style.display = 'flex';
            
            // Update navigation for teacher
            document.querySelector('.nav-tabs').innerHTML = `
                <button class="nav-tab active" data-tab="teacher-overview">üìä Class Overview</button>
                <button class="nav-tab" data-tab="teacher-assessments">üìù Skills Assessment</button>
                <button class="nav-tab" data-tab="teacher-analytics">üìà Analytics</button>
                <button class="nav-tab" data-tab="teacher-students">üë• Student Data</button>
                <button class="nav-tab" data-tab="teacher-reports">üìã Reports</button>
            `;
            
            // Show teacher-specific interface
            document.querySelector('.main-content').innerHTML = `
                <!-- Teacher Overview Tab -->
                <div id="teacher-overviewTab" class="teacher-dashboard">
                    <div class="teacher-header">
                        <h2>Class Overview</h2>
                        <p>Welcome, ${currentUser.full_name}! Manage your students and track their progress.</p>
                    </div>
                    
                    <div class="class-selector">
                        <label for="teacherClassSelect">Select Class:</label>
                        <select id="teacherClassSelect" onchange="loadClassStudents()">
                            <option value="">All Classes</option>
                            <option value="Year 1C">Year 1C</option>
                            <option value="Year 2H">Year 2H</option>
                            <option value="Year 3S">Year 3S</option>
                            <option value="Year 4B">Year 4B</option>
                            <option value="Year 5J">Year 5J</option>
                            <option value="Year 6I">Year 6I</option>
                        </select>
                    </div>
                    
                    <div class="students-grid" id="studentsGrid">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading students...
                        </div>
                    </div>
                </div>

                <!-- Teacher Skills Assessment Tab -->
                <div id="teacher-assessmentsTab" class="teacher-dashboard hidden">
                    <div class="teacher-header">
                        <h2>Skills Assessment Management</h2>
                        <p>Evaluate student SKILLS performance (0-20 points). Self-assessments are view-only.</p>
                    </div>
                    
                    <div class="assessment-filters">
                        <select id="assessmentClassFilter" onchange="loadAssessmentData()">
                            <option value="">All Classes</option>
                            <option value="Year 1C">Year 1C</option>
                            <option value="Year 2H">Year 2H</option>
                            <option value="Year 3S">Year 3S</option>
                        </select>
                        
                        <select id="assessmentSportFilter" onchange="loadAssessmentData()">
                            <option value="">All Sports</option>
                            <option value="basketball">Basketball</option>
                            <option value="football">Football</option>
                            <option value="handball">Handball</option>
                        </select>
                    </div>
                    
                    <div class="assessment-grid" id="assessmentGrid">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading assessments...
                        </div>
                    </div>
                </div>

                <!-- Teacher Analytics Tab -->
                <div id="teacher-analyticsTab" class="teacher-dashboard hidden">
                    <div class="teacher-header">
                        <h2>Performance Analytics</h2>
                        <p>Compare class performance and track individual student progress.</p>
                    </div>
                    
                    <div class="analytics-cards">
                        <div class="analytics-card">
                            <h3>Class Performance Comparison</h3>
                            <div class="class-comparison" id="classComparison">
                                <div class="class-stat">
                                    <div class="class-name">Year 1C</div>
                                    <div class="class-average">Average: 85%</div>
                                    <div class="class-progress">
                                        <div class="progress-bar" style="width: 85%"></div>
                                    </div>
                                </div>
                                <div class="class-stat">
                                    <div class="class-name">Year 2H</div>
                                    <div class="class-average">Average: 78%</div>
                                    <div class="class-progress">
                                        <div class="progress-bar" style="width: 78%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3>House Points Distribution</h3>
                            <div class="house-analytics" id="houseAnalytics">
                                <div class="house-stat red">
                                    <div class="house-name">Red House</div>
                                    <div class="house-total">1,250 pts</div>
                                    <div class="house-students">45 students</div>
                                </div>
                                <div class="house-stat green">
                                    <div class="house-name">Green House</div>
                                    <div class="house-total">1,180 pts</div>
                                    <div class="house-students">42 students</div>
                                </div>
                                <div class="house-stat yellow">
                                    <div class="house-name">Yellow House</div>
                                    <div class="house-total">1,320 pts</div>
                                    <div class="house-students">48 students</div>
                                </div>
                                <div class="house-stat blue">
                                    <div class="house-name">Blue House</div>
                                    <div class="house-total">1,290 pts</div>
                                    <div class="house-students">46 students</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3>Assessment Completion Rates</h3>
                            <div class="completion-stats" id="completionStats">
                                <div class="completion-item">
                                    <span>Self-Assessments</span>
                                    <div class="completion-bar">
                                        <div class="completion-fill" style="width: 92%"></div>
                                        <span class="completion-text">92%</span>
                                    </div>
                                </div>
                                <div class="completion-item">
                                    <span>Skills Evaluations</span>
                                    <div class="completion-bar">
                                        <div class="completion-fill" style="width: 76%"></div>
                                        <span class="completion-text">76%</span>
                                    </div>
                                </div>
                                <div class="completion-item">
                                    <span>Quiz Completion</span>
                                    <div class="completion-bar">
                                        <div class="completion-fill" style="width: 84%"></div>
                                        <span class="completion-text">84%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Teacher Student Data Tab -->
                <div id="teacher-studentsTab" class="teacher-dashboard hidden">
                    <div class="teacher-header">
                        <h2>Individual Student Data</h2>
                        <p>View detailed student profiles and progress tracking.</p>
                    </div>
                    
                    <div class="student-search">
                        <input type="text" id="studentSearchInput" placeholder="Search students by name or ID..." onkeyup="searchStudents()">
                    </div>
                    
                    <div class="student-details-grid" id="studentDetailsGrid">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading student data...
                        </div>
                    </div>
                </div>

                <!-- Teacher Reports Tab -->
                <div id="teacher-reportsTab" class="teacher-dashboard hidden">
                    <div class="teacher-header">
                        <h2>Progress Reports</h2>
                        <p>Generate and export comprehensive progress reports.</p>
                    </div>
                    
                    <div class="report-options">
                        <div class="report-card">
                            <h3>Class Progress Report</h3>
                            <p>Complete overview of class performance across all sports and assessments.</p>
                            <div class="report-controls">
                                <select id="reportClassSelect">
                                    <option value="">Select Class</option>
                                    <option value="Year 1C">Year 1C</option>
                                    <option value="Year 2H">Year 2H</option>
                                </select>
                                <button class="report-btn" onclick="generateClassReport()">üìä Generate Report</button>
                                <button class="report-btn secondary" onclick="exportClassReport()">üìÑ Export PDF</button>
                            </div>
                        </div>
                        
                        <div class="report-card">
                            <h3>Individual Student Report</h3>
                            <p>Detailed progress report for a specific student including avatar progression.</p>
                            <div class="report-controls">
                                <select id="reportStudentSelect">
                                    <option value="">Select Student</option>
                                </select>
                                <button class="report-btn" onclick="generateStudentReport()">üë§ Generate Report</button>
                                <button class="report-btn secondary" onclick="exportStudentReport()">üìÑ Export PDF</button>
                            </div>
                        </div>
                        
                        <div class="report-card">
                            <h3>House Points Summary</h3>
                            <p>House competition standings and point distribution analysis.</p>
                            <div class="report-controls">
                                <button class="report-btn" onclick="generateHouseReport()">üèÜ Generate Report</button>
                                <button class="report-btn secondary" onclick="exportHouseReport()">üìÑ Export PDF</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="report-preview" id="reportPreview">
                        <!-- Generated reports will appear here -->
                    </div>
                </div>
            `;
            
            // Setup teacher navigation
            setupTeacherNavigation();
            loadClassStudents();
        }

        function checkExistingUser() {
            const userData = localStorage.getItem('peHubUser');
            if (userData) {
                currentUser = JSON.parse(userData);
                if (currentUser.user_type === 'teacher') {
                    showTeacherDashboard();
                } else {
                    showMainApp();
                }
            }
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('appContainer').style.display = 'flex';
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.full_name;
            document.getElementById('userClass').textContent = currentUser.class_grade;
            document.getElementById('userHouse').textContent = `${currentUser.house_team.charAt(0).toUpperCase() + currentUser.house_team.slice(1)} House`;
            
            // Set avatar images
            if (currentUser.profile_photo) {
                document.getElementById('headerAvatarImg').src = currentUser.profile_photo;
                document.getElementById('avatarHeadImg').src = currentUser.profile_photo;
            }
            
            loadSportsData();
            updateDashboard();
            updateAvatar();
        }

        // Logout: clear current user and return to inscription/registration menu
        function logout() {
            currentUser = null;
            localStorage.removeItem('peHubUser');

            // Hide main app and show auth screen
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('authScreen').classList.remove('hidden');

            // Reset displayed user info
            const nameEl = document.getElementById('userName');
            if (nameEl) nameEl.textContent = '';
            const avatarImg = document.getElementById('headerAvatarImg');
            if (avatarImg) avatarImg.src = '';

            // Reset forms and UI to default registration state
            try {
                const sForm = document.getElementById('studentForm'); if (sForm) sForm.reset();
                const tForm = document.getElementById('teacherForm'); if (tForm) tForm.reset();
                document.querySelectorAll('.house-btn').forEach(b => b.classList.remove('selected'));
                document.querySelectorAll('.user-type-btn').forEach(b => b.classList.remove('active'));
                const studentBtn = document.querySelector('.user-type-btn[data-type="student"]');
                if (studentBtn) studentBtn.classList.add('active');
                currentUserType = 'student';
                toggleAuthForms();
            } catch (e) {
                console.warn('Error resetting forms on logout', e);
            }

            showNotification('Logged out ‚Äî returned to registration menu', 'info');
        }

        function switchTab(tabName) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Hide all views
            hideAllViews();

            // Show selected view
            currentView = tabName;
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
            
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'sports') {
                loadSportsData();
            } else if (tabName === 'quiz') {
                loadQuizMap();
            }
        }

        function hideAllViews() {
            document.querySelectorAll('#dashboardTab, #sportsTab, #quizTab, #leaderboardTab, #profileTab, #sportDetailView, #lessonDetailView, #assessmentView, #skillsView, #sportHistoryView, #quizLevelView').forEach(view => {
                view.classList.add('hidden');
            });
        }

        function loadQuizMap() {
            const quizMap = document.getElementById('quizMap');
            quizMap.innerHTML = '';

            // Update quiz stats
            document.getElementById('currentQuizLevel').textContent = currentQuizLevel;
            document.getElementById('completedQuizLevels').textContent = completedQuizLevels.length;

            // Generate 100 quiz levels
            for (let i = 1; i <= 100; i++) {
                const quizLevel = document.createElement('div');
                quizLevel.className = 'quiz-level';
                
                if (completedQuizLevels.includes(i)) {
                    quizLevel.classList.add('completed');
                } else if (i === currentQuizLevel) {
                    quizLevel.classList.add('available');
                } else if (i > currentQuizLevel) {
                    quizLevel.classList.add('locked');
                } else {
                    quizLevel.classList.add('available');
                }
                
                quizLevel.textContent = i;
                
                if (!quizLevel.classList.contains('locked')) {
                    quizLevel.addEventListener('click', () => {
                        startQuizLevel(i);
                    });
                }
                
                quizMap.appendChild(quizLevel);
            }
        }

        function startQuizLevel(level) {
            currentQuizLevel = level;
            currentQuizQuestion = 0;
            quizAnswers = [];
            
            // Generate quiz questions for this level
            generateQuizQuestions(level);
            
            hideAllViews();
            document.getElementById('quizLevelView').classList.remove('hidden');
            
            document.getElementById('quizLevelTitle').textContent = `Level ${level} Quiz`;
            
            // Show quiz introduction
            showQuizIntro();
        }

        function generateQuizQuestions(level) {
            quizQuestions = [];
            
            // Generate 10 questions, one from each topic
            QUIZ_TOPICS.forEach((topic, index) => {
                const sampleQuestions = SAMPLE_QUIZ_QUESTIONS[topic];
                if (sampleQuestions && sampleQuestions.length > 0) {
                    // For demo, use the sample question
                    quizQuestions.push({
                        topic: topic,
                        ...sampleQuestions[0]
                    });
                } else {
                    // Generate a placeholder question
                    quizQuestions.push({
                        topic: topic,
                        question: `What is an important aspect of ${topic}?`,
                        options: [
                            "Option A - Basic understanding",
                            "Option B - Advanced knowledge", 
                            "Option C - Expert application",
                            "Option D - Comprehensive mastery"
                        ],
                        correct: 1,
                        explanation: `This question tests your understanding of ${topic} concepts.`
                    });
                }
            });
        }

        function showQuizIntro() {
            const quizIntro = document.getElementById('quizIntro');
            quizIntro.innerHTML = `
                <h3>Level ${currentQuizLevel} - PE Knowledge Challenge</h3>
                <p>Test your understanding across 10 core PE topics. Each question covers a different area of physical education knowledge.</p>
                <p>Complete all 10 questions to earn 1 house point!</p>
                <div class="author-citation">Educational content by PE Learning Hub Team</div>
            `;
            
            const quizContainer = document.getElementById('quizQuestionContainer');
            quizContainer.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <button class="quiz-btn" onclick="startQuizQuestions()">Begin Quiz</button>
                </div>
            `;
        }

        function startQuizQuestions() {
            currentQuizQuestion = 0;
            showQuizQuestion();
        }

        function showQuizQuestion() {
            if (currentQuizQuestion >= quizQuestions.length) {
                showQuizResults();
                return;
            }

            const question = quizQuestions[currentQuizQuestion];
            document.getElementById('currentQuestionNum').textContent = currentQuizQuestion + 1;
            
            const quizContainer = document.getElementById('quizQuestionContainer');
            quizContainer.innerHTML = `
                <div class="question-header">
                    <div class="question-topic">${question.topic}</div>
                    <div class="question-text">${question.question}</div>
                </div>
                
                <div class="answer-options">
                    ${question.options.map((option, index) => `
                        <div class="answer-option" data-answer="${index}">
                            <div class="answer-letter">${String.fromCharCode(65 + index)}</div>
                            <div class="answer-text">${option}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="feedback-container" id="feedbackContainer">
                    <div class="feedback-title" id="feedbackTitle"></div>
                    <div class="feedback-text" id="feedbackText"></div>
                </div>
                
                <div class="quiz-actions">
                    <button class="quiz-btn" id="nextQuestionBtn" onclick="nextQuestion()" style="display: none;">
                        ${currentQuizQuestion === quizQuestions.length - 1 ? 'Finish Quiz' : 'Next Question'}
                    </button>
                </div>
            `;

            // Add click handlers for answer options
            document.querySelectorAll('.answer-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const selectedAnswer = parseInt(e.target.closest('.answer-option').dataset.answer);
                    selectAnswer(selectedAnswer);
                });
            });
        }

        function selectAnswer(selectedAnswer) {
            const question = quizQuestions[currentQuizQuestion];
            const isCorrect = selectedAnswer === question.correct;
            
            // Store answer
            quizAnswers[currentQuizQuestion] = {
                selected: selectedAnswer,
                correct: question.correct,
                isCorrect: isCorrect
            };

            // Update UI
            document.querySelectorAll('.answer-option').forEach((option, index) => {
                option.style.pointerEvents = 'none';
                
                if (index === question.correct) {
                    option.classList.add('correct');
                } else if (index === selectedAnswer && !isCorrect) {
                    option.classList.add('incorrect');
                }
            });

            // Show feedback
            const feedbackContainer = document.getElementById('feedbackContainer');
            const feedbackTitle = document.getElementById('feedbackTitle');
            const feedbackText = document.getElementById('feedbackText');
            
            feedbackContainer.classList.add('show');
            feedbackContainer.classList.add(isCorrect ? 'correct' : 'incorrect');
            feedbackTitle.classList.add(isCorrect ? 'correct' : 'incorrect');
            feedbackTitle.textContent = isCorrect ? 'Correct!' : 'Incorrect';
            feedbackText.textContent = question.explanation;

            // Show next button
            document.getElementById('nextQuestionBtn').style.display = 'inline-block';
        }

        function nextQuestion() {
            currentQuizQuestion++;
            showQuizQuestion();
        }

        async function showQuizResults() {
            const correctAnswers = quizAnswers.filter(answer => answer.isCorrect).length;
            const totalQuestions = quizQuestions.length;
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            
            const quizContainer = document.getElementById('quizQuestionContainer');
            quizContainer.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <h3 style="color: var(--text-light); margin-bottom: 1rem;">Quiz Complete!</h3>
                    <div style="font-size: 3rem; margin: 1rem 0;">${percentage >= 70 ? 'üéâ' : 'üìö'}</div>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        You scored ${correctAnswers} out of ${totalQuestions} (${percentage}%)
                    </p>
                    
                    ${percentage >= 70 ? `
                        <div style="background: rgba(40, 167, 69, 0.1); border: 2px solid var(--accent-secondary); border-radius: 12px; padding: 1.5rem; margin: 1rem 0;">
                            <h4 style="color: var(--accent-secondary); margin-bottom: 0.5rem;">Congratulations!</h4>
                            <p style="color: var(--text-light);">You earned 1 house point for completing this quiz!</p>
                        </div>
                    ` : `
                        <div style="background: rgba(255, 193, 7, 0.1); border: 2px solid var(--house-yellow); border-radius: 12px; padding: 1.5rem; margin: 1rem 0;">
                            <h4 style="color: var(--house-yellow); margin-bottom: 0.5rem;">Keep Learning!</h4>
                            <p style="color: var(--text-light);">You need 70% or higher to earn house points. Try again!</p>
                        </div>
                    `}
                    
                    <div style="margin-top: 2rem;">
                        <button class="quiz-btn" onclick="switchTab('quiz')">Back to Quiz Map</button>
                        ${percentage < 70 ? '<button class="quiz-btn secondary" onclick="startQuizLevel(' + currentQuizLevel + ')">Try Again</button>' : ''}
                    </div>
                </div>
            `;

            // Award house point if passed
            if (percentage >= 70 && !completedQuizLevels.includes(currentQuizLevel)) {
                completedQuizLevels.push(currentQuizLevel);
                
                // Sync completed quiz levels to currentUser
                if (currentUser) {
                    currentUser.completed_quiz_levels = completedQuizLevels.slice();
                    localStorage.setItem('peHubUser', JSON.stringify(currentUser));
                    updateDashboard(); // Refresh dashboard to show updated quiz count
                }
                
                // Update user's house points and quiz progress
                if (window.dataSdk && currentUser) {
                    const userRecord = userData.find(record => record.user_id === (currentUser.student_id || currentUser.user_id));
                    if (userRecord) {
                        const newHousePoints = (userRecord.house_points || 0) + 1;
                        const newQuizProgress = JSON.stringify({
                            currentLevel: Math.max(currentQuizLevel + 1, currentQuizLevel),
                            completed: completedQuizLevels
                        });

                        await window.dataSdk.update({
                            ...userRecord,
                            house_points: newHousePoints,
                            quiz_progress: newQuizProgress
                        });

                        // Update current user data
                        currentUser.house_points = newHousePoints;
                        localStorage.setItem('peHubUser', JSON.stringify(currentUser));
                    }
                }
            }
        }

        function loadSportsData() {
            const sportsContainer = document.getElementById('sportsTab');
            sportsContainer.innerHTML = '';

            Object.entries(SPORTS_DATA).forEach(([sportKey, sport]) => {
                const sportCard = document.createElement('div');
                sportCard.className = 'sport-card';
                sportCard.innerHTML = `
                    <div class="sport-icon">${sport.icon}</div>
                    <div class="sport-name">${sport.name}</div>
                    <div class="sport-progress">0/10 lessons completed</div>
                `;
                sportCard.addEventListener('click', () => {
                    currentSport = sportKey;
                    showSportDetail();
                });
                sportsContainer.appendChild(sportCard);
            });
        }

        function showSportDetail() {
            if (!currentSport) return;
            
            hideAllViews();
            document.getElementById('sportDetailView').classList.remove('hidden');
            
            const sport = SPORTS_DATA[currentSport];
            document.getElementById('sportDetailTitle').textContent = sport.name;
            
            loadLessons();
        }

        function loadLessons() {
            const lessonGrid = document.getElementById('lessonGrid');
            lessonGrid.innerHTML = '';

            // Load lessons 1-10
            for (let i = 1; i <= 10; i++) {
                const lesson = LESSON_STRUCTURE[i];
                const lessonTile = document.createElement('div');
                lessonTile.className = `lesson-tile ${lesson.type}`;
                // For lessons where students enter their topic, prefer saved topic as tile title
                const studentEditableLessons = [2,3,4,6,7,8];
                let displayTitle = lesson.title;
                let displayType = lesson.description;
                let statusClass = (i > 1) ? 'locked' : '';
                let statusIcon = (i > 1) ? 'üîí' : '‚úì';

                try {
                    const progressData = currentUser && currentUser.sport_progress ? JSON.parse(currentUser.sport_progress || '{}') : {};
                    const lessonProgress = progressData[currentSport] && progressData[currentSport][`lesson_${i}`] ? progressData[currentSport][`lesson_${i}`] : null;
                    if (lessonProgress && lessonProgress.selfEvaluation && lessonProgress.selfEvaluation.topic) {
                        displayTitle = lessonProgress.selfEvaluation.topic;
                    }
                    if (lessonProgress && lessonProgress.completed) {
                        statusClass = '';
                        statusIcon = '‚úì';
                    }
                } catch (e) {
                    // ignore parse errors
                }

                // If this lesson is student-editable, keep tile minimal (title + status)
                if (studentEditableLessons.includes(i)) {
                    lessonTile.innerHTML = `
                        <div class="lesson-number">${i}</div>
                        <div class="lesson-title">${escapeHtml(displayTitle)}</div>
                        <div class="lesson-type"></div>
                        <div class="lesson-status ${statusClass}">${statusIcon}</div>
                    `;
                } else {
                    lessonTile.innerHTML = `
                        <div class="lesson-number">${i}</div>
                        <div class="lesson-title">${escapeHtml(displayTitle)}</div>
                        <div class="lesson-type">${displayType}</div>
                        <div class="lesson-status ${statusClass}">${statusIcon}</div>
                    `;
                }
                
                lessonTile.addEventListener('click', () => {
                    if (i === 1 || i <= 10) { // For demo, allow access to all lessons
                        currentLesson = i;
                        if (lesson.type === 'assessment') {
                            showAssessmentView();
                        } else {
                            showLessonDetail();
                        }
                    }
                });
                
                lessonGrid.appendChild(lessonTile);
            }

            // Add Skills tile (lesson 11)
            const skillsTile = document.createElement('div');
            skillsTile.className = 'lesson-tile skills';
            skillsTile.innerHTML = `
                <div class="lesson-number">üìä</div>
                <div class="lesson-title">SKILLS</div>
                <div class="lesson-type">Teacher evaluation (0-20 points)</div>
                <div class="lesson-status locked">üîí</div>
            `;
            skillsTile.addEventListener('click', () => {
                if (currentUser.user_type === 'teacher') {
                    showSkillsView();
                } else {
                    showNotification('Skills assessment is only available to teachers', 'info');
                }
            });
            lessonGrid.appendChild(skillsTile);

            // Add History tile (lesson 12)
            const historyTile = document.createElement('div');
            historyTile.className = 'lesson-tile history';
            historyTile.innerHTML = `
                <div class="lesson-number">üìö</div>
                <div class="lesson-title">Sport History</div>
                <div class="lesson-type">Origins and evolution + Quiz</div>
                <div class="lesson-status">‚úì</div>
            `;
            historyTile.addEventListener('click', () => {
                showSportHistoryView();
            });
            lessonGrid.appendChild(historyTile);
        }

        async function showLessonDetail() {
            if (!currentLesson) return;

            hideAllViews();
            document.getElementById('lessonDetailView').classList.remove('hidden');

            const lesson = LESSON_STRUCTURE[currentLesson];
            document.getElementById('lessonTitle').textContent = `Lesson ${currentLesson}: ${lesson.title}`;

            const lessonContent = document.getElementById('lessonContent');

            // Show loading state for better UX (sub-2-second load times)
            lessonContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Loading lesson content...
                </div>
            `;

            try {
                // Load dynamic content from content management system
                const content = await CONTENT_MANAGER.loadLessonContent(currentSport, currentLesson);

                // Render lesson with loaded content
                // For specific practice lessons allow student topic input, self-evaluation and how-to criteria
                const studentEditableLessons = [2,3,4,6,7,8];
                const isStudentEditable = studentEditableLessons.includes(currentLesson);

                // For student-editable lessons we do not render the generic content; show only student inputs
                if (isStudentEditable) {
                    // Use saved topic if available
                    let savedTopic = '';
                    try {
                        const progressData = currentUser && currentUser.sport_progress ? JSON.parse(currentUser.sport_progress || '{}') : {};
                        const lessonProgress = progressData[currentSport] && progressData[currentSport][`lesson_${currentLesson}`] ? progressData[currentSport][`lesson_${currentLesson}`] : null;
                        if (lessonProgress && lessonProgress.selfEvaluation && lessonProgress.selfEvaluation.topic) savedTopic = lessonProgress.selfEvaluation.topic;
                    } catch (e) { }

                    document.getElementById('lessonTitle').textContent = `Lesson ${currentLesson}: ${savedTopic || lesson.title}`;

                    lessonContent.innerHTML = `
                        <div style="background: var(--surface-light); border-radius: 16px; padding: 2rem; color: var(--text-light);">
                            <div id="studentInputs" style="text-align:left;">
                                <h4 style="color: var(--text-light);">Student Inputs</h4>
                                <div style="margin-bottom:0.75rem;">
                                    <label style="font-weight:600; color:var(--text-light);">Lesson Topic (write the topic of the day)</label>
                                    <input id="lessonTopic" type="text" placeholder="Enter lesson topic" style="width:100%; padding:0.5rem; border-radius:6px; border:1px solid var(--border-light);" value="${escapeHtml(savedTopic)}" />
                                </div>

                                <div style="margin-bottom:0.75rem;">
                                    <label style="font-weight:600; color:var(--text-light);">Warm-up: Self-evaluation (Level 1-4)</label>
                                    <select id="warmupLevel" style="width:200px; padding:0.5rem; border-radius:6px;">
                                        <option value="1">1 - Beginner</option>
                                        <option value="2">2 - Explorer</option>
                                        <option value="3">3 - Performer</option>
                                        <option value="4">4 - Champion</option>
                                    </select>
                                    <textarea id="warmupNote" placeholder="Explain why you selected this level (teacher gives criteria orally)" style="width:100%; margin-top:0.5rem; padding:0.5rem; min-height:60px; border-radius:6px; border:1px solid var(--border-light);"></textarea>
                                </div>

                                <div style="margin-bottom:0.75rem;">
                                    <label style="font-weight:600; color:var(--text-light);">Exercise: Write the skills you practiced</label>
                                    <div id="exerciseSkillsContainer">
                                        <input class="exercise-skill-input" type="text" placeholder="Skill practiced #1" style="width:100%; padding:0.5rem; border-radius:6px; border:1px solid var(--border-light); margin-bottom:0.5rem;" />
                                    </div>
                                    <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
                                        <button id="addExerciseSkillBtn" class="photo-btn" type="button">+ Add skill</button>
                                        <button id="clearExerciseSkillBtn" class="photo-btn" type="button">Clear</button>
                                    </div>
                                </div>

                                <div style="margin-bottom:0.75rem;">
                                    <label style="font-weight:600; color:var(--text-light);">How-to Criteria (up to 3) ‚Äî write steps or criteria for the skills you practiced</label>
                                    <div id="howToContainer">
                                        <input class="howto-input" type="text" placeholder="How to do #1" style="width:100%; padding:0.5rem; border-radius:6px; border:1px solid var(--border-light); margin-bottom:0.5rem;" />
                                    </div>
                                    <div style="display:flex; gap:0.5rem; margin-top:0.5rem;"><button id="addHowToBtn" class="photo-btn" type="button">+ Add criterion</button><button id="clearHowToBtn" class="photo-btn" type="button">Clear</button></div>
                                </div>
                            </div>

                            <div style="margin-top: 2rem; text-align: center;">
                                <button class="assessment-btn" onclick="markLessonComplete(${currentLesson})">Complete Lesson</button>
                            </div>
                        </div>
                    `;

                    setupLessonStudentInputs();

                    return;
                }
            } catch (error) {
                console.error('Failed to load lesson content:', error);
                lessonContent.innerHTML = `
                    <div style="background: var(--surface-light); border-radius: 16px; padding: 2rem; color: var(--text-light); text-align: center;">
                        <h3>Content Loading Error</h3>
                        <p style="color: var(--text-secondary); margin: 1rem 0;">Unable to load lesson content. Please try again.</p>
                        <button class="assessment-btn" onclick="showLessonDetail()">Retry</button>
                    </div>
                `;
            }
        }

        async function markLessonComplete(lessonNumber) {
            if (!currentUser || !currentSport) return;
            
            // Update user progress
            const progressData = JSON.parse(currentUser.sport_progress || '{}');
            if (!progressData[currentSport]) {
                progressData[currentSport] = {};
            }

            // If student inputs exist, capture them and include in progress
            const selfEval = {};
            try {
                const topicEl = document.getElementById('lessonTopic');
                const warmupLevelEl = document.getElementById('warmupLevel');
                const warmupNoteEl = document.getElementById('warmupNote');
                const exerciseLevelEl = document.getElementById('exerciseLevel');
                const exerciseNoteEl = document.getElementById('exerciseNote');
                const exerciseSkillEls = document.querySelectorAll('.exercise-skill-input');
                const howToEls = document.querySelectorAll('.howto-input');

                if (topicEl) selfEval.topic = topicEl.value.trim();
                if (warmupLevelEl) {
                    const lvl = parseInt(warmupLevelEl.value || '1', 10);
                    selfEval.warmup = { level: lvl, points: levelToPoints(lvl), note: warmupNoteEl ? warmupNoteEl.value.trim() : '' };
                }
                // If students provided exercise skills (new format), save them; otherwise keep old level/note structure
                if (exerciseSkillEls && exerciseSkillEls.length) {
                    selfEval.exercise = { skills: Array.from(exerciseSkillEls).map(i => i.value.trim()).filter(Boolean).slice(0,6) };
                } else if (exerciseLevelEl) {
                    const lvl = parseInt(exerciseLevelEl.value || '1', 10);
                    selfEval.exercise = { level: lvl, points: levelToPoints(lvl), note: exerciseNoteEl ? exerciseNoteEl.value.trim() : '' };
                }
                if (howToEls && howToEls.length) {
                    selfEval.howTo = Array.from(howToEls).map(i => i.value.trim()).filter(Boolean).slice(0,3);
                }
            } catch (e) {
                console.warn('Error reading student inputs', e);
            }

            progressData[currentSport][`lesson_${lessonNumber}`] = {
                completed: true,
                completedAt: new Date().toISOString(),
                selfEvaluation: Object.keys(selfEval).length ? selfEval : undefined
            };
            
            // Check if all main lessons (1-10) are completed for this sport to mark sport as completed
            const mainLessons = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            const allMainCompleted = mainLessons.every(l => progressData[currentSport][`lesson_${l}`]?.completed);
            if (allMainCompleted && currentUser) {
                if (!currentUser.completed_sports) {
                    currentUser.completed_sports = [];
                }
                if (!currentUser.completed_sports.includes(currentSport)) {
                    currentUser.completed_sports.push(currentSport);
                }
            }
            
            // Save to database with optimistic updates
            if (window.dataSdk) {
                const userRecord = userData.find(record => record.user_id === currentUser.student_id);
                if (userRecord) {
                    await window.dataSdk.update({
                        ...userRecord,
                        sport_progress: JSON.stringify(progressData),
                        completed_sports: currentUser.completed_sports || []
                    });
                }
            }

            // Update local currentUser and persist locally so UI reflects changes immediately
            try {
                currentUser.sport_progress = JSON.stringify(progressData);
                localStorage.setItem('peHubUser', JSON.stringify(currentUser));
                updateDashboard(); // Refresh dashboard to show updated sports count

                // Also update local list of users if present
                try {
                    const users = JSON.parse(localStorage.getItem('peHubUsers') || '[]');
                    const idx = users.findIndex(u => (u.user_id || u.student_id) === (currentUser.user_id || currentUser.student_id));
                    if (idx >= 0) {
                        users[idx] = { ...users[idx], sport_progress: currentUser.sport_progress, completed_sports: currentUser.completed_sports || [] };
                    } else {
                        users.push(currentUser);
                    }
                    localStorage.setItem('peHubUsers', JSON.stringify(users));
                } catch (e) {
                    // ignore
                }
            } catch (e) {
                console.warn('Failed to persist lesson progress locally', e);
            }

            showNotification(`Lesson ${lessonNumber} completed! Great work!`, 'success');
            showSportDetail(); // Return to sport overview
        }

        function showAssessmentView() {
            hideAllViews();
            document.getElementById('assessmentView').classList.remove('hidden');
            
            const lesson = LESSON_STRUCTURE[currentLesson];
            document.getElementById('assessmentTitle').textContent = lesson.title;
            document.getElementById('assessmentSubtitle').textContent = lesson.description;
            
            loadAssessmentSkills();
        }

        function loadAssessmentSkills() {
            const assessmentContent = document.getElementById('assessmentContent');
            assessmentContent.innerHTML = '';

            Object.entries(ASSESSMENT_SKILLS).forEach(([skillKey, skill]) => {
                const skillDiv = document.createElement('div');
                skillDiv.className = 'skill-assessment';
                
                skillDiv.innerHTML = `
                    <div class="skill-title">${skill.title}</div>
                    <div class="skill-description">${skill.description}</div>
                    <div class="skill-levels" data-skill="${skillKey}">
                        ${Object.entries(SKILL_LEVELS).map(([level, levelData]) => `
                            <div class="skill-level" data-level="${level}">
                                <div class="level-number">${level}</div>
                                <div class="level-name">${levelData.name}</div>
                                <div class="level-description">${levelData.description}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                assessmentContent.appendChild(skillDiv);
            });

            // Add click handlers for skill levels
            document.querySelectorAll('.skill-level').forEach(level => {
                level.addEventListener('click', (e) => {
                    const skillKey = e.target.closest('.skill-levels').dataset.skill;
                    const levelValue = e.target.closest('.skill-level').dataset.level;
                    
                    // Remove previous selection
                    e.target.closest('.skill-levels').querySelectorAll('.skill-level').forEach(l => {
                        l.classList.remove('selected');
                    });
                    
                    // Add selection
                    e.target.closest('.skill-level').classList.add('selected');
                    
                    // Store assessment
                    currentAssessment[skillKey] = parseInt(levelValue);
                });
            });
        }

        // Map level to simple points (can be adjusted later)
        function levelToPoints(level) {
            // Levels 1..4 map to points 1..4 for simple auto-evaluation
            const l = parseInt(level || 1, 10);
            if (isNaN(l) || l < 1) return 1;
            if (l > 4) return 4;
            return l;
        }

        // Simple HTML-escape helper for inserting user text into templates
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Setup student input handlers in lesson detail view
        function setupLessonStudentInputs() {
            // Add/remove how-to fields (max 3)
            const addBtn = document.getElementById('addHowToBtn');
            const clearBtn = document.getElementById('clearHowToBtn');
            const howToContainer = document.getElementById('howToContainer');

            if (addBtn && howToContainer) {
                addBtn.addEventListener('click', () => {
                    const existing = howToContainer.querySelectorAll('.howto-input').length;
                    if (existing >= 3) {
                        showNotification('You can add up to 3 criteria only', 'info');
                        return;
                    }
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'howto-input';
                    input.placeholder = `How to do #${existing + 1}`;
                    input.style.width = '100%';
                    input.style.padding = '0.5rem';
                    input.style.borderRadius = '6px';
                    input.style.border = '1px solid var(--border-light)';
                    input.style.marginBottom = '0.5rem';
                    howToContainer.appendChild(input);
                });
            }

            if (clearBtn && howToContainer) {
                clearBtn.addEventListener('click', () => {
                    howToContainer.innerHTML = '<input class="howto-input" type="text" placeholder="How to do #1" style="width:100%; padding:0.5rem; border-radius:6px; border:1px solid var(--border-light); margin-bottom:0.5rem;" />';
                });
            }

            // Exercise skills add/remove (max 6)
            const addExerciseBtn = document.getElementById('addExerciseSkillBtn');
            const clearExerciseBtn = document.getElementById('clearExerciseSkillBtn');
            const exerciseContainer = document.getElementById('exerciseSkillsContainer');

            if (addExerciseBtn && exerciseContainer) {
                addExerciseBtn.addEventListener('click', () => {
                    const existing = exerciseContainer.querySelectorAll('.exercise-skill-input').length;
                    if (existing >= 6) {
                        showNotification('You can add up to 6 skills only', 'info');
                        return;
                    }
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'exercise-skill-input';
                    input.placeholder = `Skill practiced #${existing + 1}`;
                    input.style.width = '100%';
                    input.style.padding = '0.5rem';
                    input.style.borderRadius = '6px';
                    input.style.border = '1px solid var(--border-light)';
                    input.style.marginBottom = '0.5rem';
                    exerciseContainer.appendChild(input);
                });
            }

            if (clearExerciseBtn && exerciseContainer) {
                clearExerciseBtn.addEventListener('click', () => {
                    exerciseContainer.innerHTML = '<input class="exercise-skill-input" type="text" placeholder="Skill practiced #1" style="width:100%; padding:0.5rem; border-radius:6px; border:1px solid var(--border-light); margin-bottom:0.5rem;" />';
                });
            }

            // If we have saved progress for this lesson, populate the inputs
            try {
                const progressData = JSON.parse(currentUser.sport_progress || '{}');
                const lessonKey = `lesson_${currentLesson}`;
                const saved = progressData[currentSport] && progressData[currentSport][lessonKey] ? progressData[currentSport][lessonKey].selfEvaluation : null;
                if (saved) {
                    if (saved.topic) document.getElementById('lessonTopic').value = saved.topic;
                    if (saved.warmup) {
                        document.getElementById('warmupLevel').value = saved.warmup.level || '1';
                        document.getElementById('warmupNote').value = saved.warmup.note || '';
                    }
                            if (saved.exercise) {
                                // Older format stored exercise as level/note or newer format may store skills array
                                const skillsContainer = document.getElementById('exerciseSkillsContainer');
                                if (Array.isArray(saved.exercise.skills) && skillsContainer) {
                                    skillsContainer.innerHTML = '';
                                    saved.exercise.skills.slice(0,6).forEach((s, idx) => {
                                        const input = document.createElement('input');
                                        input.type = 'text';
                                        input.className = 'exercise-skill-input';
                                        input.value = s;
                                        input.placeholder = `Skill practiced #${idx+1}`;
                                        input.style.width = '100%';
                                        input.style.padding = '0.5rem';
                                        input.style.borderRadius = '6px';
                                        input.style.border = '1px solid var(--border-light)';
                                        input.style.marginBottom = '0.5rem';
                                        skillsContainer.appendChild(input);
                                    });
                                } else {
                                    // Fallback: if old level/note exist, place note into first skill input or exerciseNote if present
                                    const skillsContainer2 = document.getElementById('exerciseSkillsContainer');
                                    if (skillsContainer2) {
                                        skillsContainer2.querySelectorAll('.exercise-skill-input')[0].value = saved.exercise.note || '';
                                    }
                                }
                            }
                    if (saved.howTo && saved.howTo.length) {
                        const container = document.getElementById('howToContainer');
                        container.innerHTML = '';
                        saved.howTo.slice(0,3).forEach((c, idx) => {
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.className = 'howto-input';
                            input.value = c;
                            input.placeholder = `How to do #${idx+1}`;
                            input.style.width = '100%';
                            input.style.padding = '0.5rem';
                            input.style.borderRadius = '6px';
                            input.style.border = '1px solid var(--border-light)';
                            input.style.marginBottom = '0.5rem';
                            container.appendChild(input);
                        });
                    }
                }
            } catch (e) {
                // ignore parse errors
            }
        }

        async function saveAssessment() {
            const skillCount = Object.keys(ASSESSMENT_SKILLS).length;
            const assessedCount = Object.keys(currentAssessment).length;
            
            if (assessedCount < skillCount) {
                showNotification('Please assess all skills before saving', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveAssessment');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            // Calculate total points (for self-assessment, no house points awarded)
            const totalPoints = Object.values(currentAssessment).reduce((sum, level) => sum + level, 0);
            
            // Save assessment data
            if (window.dataSdk && currentUser) {
                const assessmentRecord = {
                    user_id: currentUser.student_id || currentUser.user_id,
                    sport: currentSport,
                    lesson: currentLesson,
                    assessment_data: JSON.stringify(currentAssessment),
                    total_points: totalPoints,
                    assessment_type: 'self',
                    created_at: new Date().toISOString()
                };

                const result = await window.dataSdk.create(assessmentRecord);
                if (result.isOk) {
                    showNotification('Assessment saved successfully!', 'success');
                    showSportDetail();
                } else {
                    showNotification('Failed to save assessment', 'error');
                }
            }

            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Assessment';
            currentAssessment = {};
        }

        function showSkillsView() {
            hideAllViews();
            document.getElementById('skillsView').classList.remove('hidden');
            
            const skillsContent = document.getElementById('skillsContent');
            skillsContent.innerHTML = `
                <div style="background: var(--surface-light); border-radius: 16px; padding: 2rem; color: var(--text-light); text-align: center;">
                    <h3>Teacher Skills Assessment</h3>
                    <p style="color: var(--text-secondary); margin: 1rem 0;">
                        This is where teachers can evaluate student performance and award house points (0-20).
                    </p>
                    <p><strong>Scoring Breakdown:</strong></p>
                    <ul style="text-align: left; margin: 1rem 0;">
                        <li>3 Motor Skills: 12 points (4 points each)</li>
                        <li>1 Methodology Skill: 4 points</li>
                        <li>1 Social Skill: 4 points</li>
                    </ul>
                    <div style="margin-top: 2rem;">
                        <button class="assessment-btn" onclick="showNotification('Teacher assessment interface coming soon!', 'info')">
                            Start Teacher Assessment
                        </button>
                    </div>
                </div>
            `;
        }

        function showSportHistoryView() {
            hideAllViews();
            document.getElementById('sportHistoryView').classList.remove('hidden');
            
            const sport = SPORTS_DATA[currentSport];
            document.getElementById('historyTitle').textContent = `${sport.name} History`;
            
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = `
                <div style="background: var(--surface-light); border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                    <h3 style="color: var(--text-light); margin-bottom: 1rem;">Origins and Evolution</h3>
                    <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 1rem;">
                        ${sport.name} has a rich history spanning many decades. The sport evolved from simple recreational activities 
                        into the organized, competitive sport we know today.
                    </p>
                    <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 1rem;">
                        Key developments include the establishment of official rules, international governing bodies, 
                        and inclusion in major sporting events.
                    </p>
                    <div class="author-citation">
                        - PE Learning Hub Educational Team
                    </div>
                </div>
                
                <div style="background: var(--surface-light); border-radius: 16px; padding: 2rem;">
                    <h3 style="color: var(--text-light); margin-bottom: 1rem;">History Quiz</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                        Test your knowledge about ${sport.name} history! Complete this 10-question quiz to earn 1 house point.
                    </p>
                    <div style="text-align: center;">
                        <button class="assessment-btn" onclick="showNotification('History quiz coming soon!', 'info')">
                            Start History Quiz
                        </button>
                    </div>
                </div>
            `;
        }

        function updateDashboard() {
            if (!currentUser) return;

            // Calculate actual completed sports (count lessons marked as complete)
            const completedSports = (currentUser.completed_sports || []).length || 0;
            
            // Calculate actual completed quizzes (count completed quiz levels)
            const completedQuizzes = (currentUser.completed_quiz_levels || []).length || 0;
            
            // Update progress rings (calculate from actual completion percentage)
            const totalActivities = 10; // estimate: count of all available sports + quiz levels
            const completedActivities = completedSports + Math.min(completedQuizzes, 10); // normalize quiz count
            const progressPercentage = Math.round((completedActivities / totalActivities) * 100);
            updateProgressRing('overallProgress', 'overallProgressText', progressPercentage);
            
            // Update statistics with real data
            document.getElementById('completedSports').textContent = completedSports;
            document.getElementById('completedQuizzes').textContent = completedQuizzes;
            
            // Update house points and level
            const housePoints = currentUser.house_points || 0;
            const avatarLevel = Math.floor(housePoints / 10) + 1;
            
            document.getElementById('housePointsDisplay').textContent = housePoints;
            document.getElementById('avatarLevel').textContent = Math.min(avatarLevel, 20);
            
            updateAvatar();
        }

        function updateAvatar() {
            if (!currentUser) return;
            
            const housePoints = currentUser.house_points || 0;
            const level = Math.min(Math.floor(housePoints / 10) + 1, 20);
            const avatarBody = document.getElementById('avatarBody');
            const avatarHead = document.getElementById('avatarHead');
            
            // 20-level progression system: Level 1 (feet/legs) -> Level 20 (full body + head)
            const bodyParts = getAvatarBodyParts(level);
            const isMale = currentUser.gender === 'male';
            
            // Update avatar display based on progression
            avatarBody.innerHTML = renderAvatarBody(level, isMale, bodyParts);
            
            // Auto-crop student photo to circular head (Level 10+)
            if (level >= 10 && currentUser.profile_photo) {
                avatarHead.style.display = 'block';
                const headImg = document.getElementById('avatarHeadImg');
                if (headImg) {
                    headImg.src = currentUser.profile_photo;
                    headImg.style.borderRadius = '50%';
                    headImg.style.objectFit = 'cover';
                }
            } else {
                avatarHead.style.display = level >= 15 ? 'block' : 'none';
            }
            
            // Smooth animation transitions
            avatarBody.style.transition = 'all 0.5s ease-in-out';
            
            // Update avatar body color based on level with high contrast for accessibility
            const hue = Math.min(level * 15, 300);
            const saturation = Math.min(50 + level * 2, 80);
            const lightness = Math.max(40, 60 - level);
            avatarBody.style.background = `linear-gradient(135deg, hsl(${hue}, ${saturation}%, ${lightness}%) 0%, hsl(${hue + 30}, ${saturation}%, ${lightness - 10}%) 100%)`;
        }

        function getAvatarBodyParts(level) {
            // Returns a set of normalized parameters used by the renderer
            // level: 1..20 -> t: 0..1
            const t = Math.max(0, Math.min(1, (level - 1) / 19));

            // muscle scales from very skinny -> very muscular
            const muscleScale = 0.6 + t * 1.4; // 0.6 .. 2.0

            // waistFactor: female narrows slightly with fitness, male stays wider
            const waistFactor = 1 - (t * 0.12);

            // limb thickness in px base values (will be multiplied)
            const armThickness = 6 + Math.round(t * 16); // 6..22
            const legThickness = 8 + Math.round(t * 18); // 8..26

            // posture: negative = slouch, zero upright, positive = powerful chest out
            const posture = -6 + Math.round(t * 12); // -6deg .. +6deg

            // face detail appears later
            const faceDetail = level >= 10;

            // flex pose for top levels
            const isFlexPose = t > 0.85;

            return {
                t,
                muscleScale,
                waistFactor,
                armThickness,
                legThickness,
                posture,
                faceDetail,
                isFlexPose
            };
        }

        function renderAvatarBody(level, isMale, parts) {
            // Render a simple SVG silhouette that varies by `isMale` and `parts` parameters.
            // `parts` contains normalized values computed by getAvatarBodyParts.
            const p = parts || getAvatarBodyParts(level);

            const width = 140;
            const height = 220;
            const torsoWidth = Math.round(40 * p.muscleScale * (isMale ? 1.05 : 0.95));
            const torsoHeight = 70 + Math.round(p.t * 30);
            const waist = Math.round(torsoWidth * (isMale ? 0.9 : p.waistFactor));
            const armW = p.armThickness;
            const legW = p.legThickness;
            const hue = 200 - Math.round(p.t * 60);
            const fillColor = `hsl(${hue}, ${50 + Math.round(p.t * 30)}%, ${50 - Math.round(p.t * 10)}%)`;

            // Head
            const head = `
                <circle cx="70" cy="36" r="18" fill="${fillColor}" stroke="#fff" stroke-width="2" />
            `;

            // Face features if allowed
            const face = p.faceDetail ? `
                <circle cx="62" cy="34" r="2" fill="#222" />
                <circle cx="78" cy="34" r="2" fill="#222" />
                <path d="M60 44 Q70 50 80 44" stroke="#222" stroke-width="2" fill="transparent" stroke-linecap="round" />
            ` : '';

            // Torso path (simple rounded trapezoid)
            const torso = `
                <path d="M ${70 - torsoWidth/2} ${60} 
                          Q ${70 - torsoWidth/2 - 6} ${60 + torsoHeight/4} ${70 - waist/2} ${60 + torsoHeight} 
                          L ${70 + waist/2} ${60 + torsoHeight} 
                          Q ${70 + torsoWidth/2 + 6} ${60 + torsoHeight/4} ${70 + torsoWidth/2} ${60} Z"
                      fill="${fillColor}" stroke="#fff" stroke-width="2" />
            `;

            // Arms (left and right) ‚Äî rotated rectangles simulated by paths
            const armOffsetY = 72;
            const leftArm = p.isFlexPose ? `
                <path d="M ${70 - torsoWidth/2 - 2} ${armOffsetY} C ${50} ${armOffsetY} ${46} ${armOffsetY-20} ${52} ${armOffsetY-36} L ${56} ${armOffsetY-32} C ${50} ${armOffsetY-18} ${64} ${armOffsetY} ${70 - torsoWidth/2} ${armOffsetY} Z" fill="${fillColor}" stroke="#fff" stroke-width="2"/>
                <circle cx="52" cy="${armOffsetY-36}" r="6" fill="${fillColor}" stroke="#fff" stroke-width="2" />
            ` : `
                <rect x="${70 - torsoWidth/2 - armW - 4}" y="${armOffsetY}" width="${armW}" height="${torsoHeight-10}" rx="${armW/2}" fill="${fillColor}" stroke="#fff" stroke-width="2" />
            `;

            const rightArm = p.isFlexPose ? `
                <path d="M ${70 + torsoWidth/2 + 2} ${armOffsetY} C ${90} ${armOffsetY} ${94} ${armOffsetY-20} ${88} ${armOffsetY-36} L ${84} ${armOffsetY-32} C ${90} ${armOffsetY-18} ${76} ${armOffsetY} ${70 + torsoWidth/2} ${armOffsetY} Z" fill="${fillColor}" stroke="#fff" stroke-width="2"/>
                <circle cx="88" cy="${armOffsetY-36}" r="${6 + Math.round(p.t*3)}" fill="${fillColor}" stroke="#fff" stroke-width="2" />
            ` : `
                <rect x="${70 + torsoWidth/2 + 4}" y="${armOffsetY}" width="${armW}" height="${torsoHeight-10}" rx="${armW/2}" fill="${fillColor}" stroke="#fff" stroke-width="2" />
            `;

            // Legs
            const legY = 60 + torsoHeight;
            const leftLeg = `
                <rect x="${70 - waist/2 - legW}" y="${legY}" width="${legW}" height="${60 + Math.round(p.t*20)}" rx="${legW/2}" fill="${fillColor}" stroke="#fff" stroke-width="2" />
            `;
            const rightLeg = `
                <rect x="${70 + waist/2}" y="${legY}" width="${legW}" height="${60 + Math.round(p.t*20)}" rx="${legW/2}" fill="${fillColor}" stroke="#fff" stroke-width="2" />
            `;

            // Feet simple
            const feet = `
                <ellipse cx="${70 - 18}" cy="${legY + 70}" rx="14" ry="6" fill="#333" opacity="${0.5 + p.t*0.5}" />
                <ellipse cx="${70 + 18}" cy="${legY + 70}" rx="14" ry="6" fill="#333" opacity="${0.5 + p.t*0.5}" />
            `;

            // Compose SVG
            const svg = `
                <svg width="${width}px" height="${height}px" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
                    <title>Avatar level ${level} ${isMale ? 'male' : 'female'}</title>
                    <g transform="rotate(${p.posture} 70 ${height/2})">
                        ${leftLeg}
                        ${rightLeg}
                        ${torso}
                        ${leftArm}
                        ${rightArm}
                        ${head}
                        ${face}
                        ${feet}
                    </g>
                </svg>
            `;

            return svg;
        }

        function updateProgressRing(ringId, textId, percentage) {
            const ring = document.getElementById(ringId);
            const text = document.getElementById(textId);
            const circumference = 326.73;
            const offset = circumference - (percentage / 100) * circumference;
            
            ring.style.strokeDashoffset = offset;
            text.textContent = `${percentage}%`;
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            document.getElementById('themeToggle').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            
            // Persist theme preference in localStorage for immediate loading
            localStorage.setItem('peHubTheme', isDarkMode ? 'dark' : 'light');
            
            // Update user preference in database
            if (currentUser && window.dataSdk) {
                const userRecord = userData.find(record => record.user_id === (currentUser.student_id || currentUser.full_name));
                if (userRecord) {
                    window.dataSdk.update({
                        ...userRecord,
                        dark_mode: isDarkMode
                    });
                }
            }
            
            // Ensure parity - same information in both modes
            updateThemeSpecificElements();
        }

        function updateThemeSpecificElements() {
            // Ensure all information is visible in both themes with proper contrast
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            
            // Update house indicators for better visibility
            document.querySelectorAll('.house-indicator').forEach(indicator => {
                if (isDark) {
                    indicator.style.border = '2px solid rgba(255,255,255,0.3)';
                } else {
                    indicator.style.border = '2px solid rgba(0,0,0,0.1)';
                }
            });
            
            // Update progress rings for theme
            document.querySelectorAll('.progress-ring .progress').forEach(ring => {
                ring.style.stroke = isDark ? '#8B5CF6' : '#667eea';
            });
        }

        function initializeTheme() {
            // Load theme preference from localStorage first for immediate application
            const savedTheme = localStorage.getItem('peHubTheme');
            if (savedTheme) {
                isDarkMode = savedTheme === 'dark';
                document.body.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
                document.getElementById('themeToggle').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            }
            
            // Then load from user data when available
            if (currentUser && currentUser.dark_mode !== undefined) {
                isDarkMode = currentUser.dark_mode;
                document.body.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
                document.getElementById('themeToggle').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
                localStorage.setItem('peHubTheme', isDarkMode ? 'dark' : 'light');
            }
            
            updateThemeSpecificElements();
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Teacher Dashboard Functions
        function setupTeacherNavigation() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => switchTeacherTab(e.target.dataset.tab));
            });
        }

        function switchTeacherTab(tabName) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Hide all teacher views
            document.querySelectorAll('.teacher-dashboard').forEach(view => {
                view.classList.add('hidden');
            });

            // Show selected view
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
            
            // Load data for specific tabs
            if (tabName === 'teacher-overview') {
                loadClassStudents();
            } else if (tabName === 'teacher-assessments') {
                loadAssessmentData();
            } else if (tabName === 'teacher-students') {
                loadStudentDetails();
            }
        }

        async function loadClassStudents() {
            const studentsGrid = document.getElementById('studentsGrid');
            const selectedClass = document.getElementById('teacherClassSelect')?.value || '';
            
            studentsGrid.innerHTML = '<div class="loading"><div class="spinner"></div>Loading students...</div>';
            
            // Filter students by class if selected
            const filteredStudents = userData.filter(student => 
                student.user_type === 'student' && 
                (selectedClass === '' || student.class_grade === selectedClass)
            );

            // Generate sample students if none exist
            const sampleStudents = filteredStudents.length > 0 ? filteredStudents : generateSampleStudents();
            
            setTimeout(() => {
                studentsGrid.innerHTML = '';
                
                sampleStudents.forEach(student => {
                    const studentCard = document.createElement('div');
                    studentCard.className = 'student-card';
                    studentCard.innerHTML = `
                        <div class="student-header">
                            <div class="student-photo">
                                ${student.profile_photo ? `<img src="${student.profile_photo}" alt="${student.full_name}">` : 'üë§'}
                            </div>
                            <div class="student-info">
                                <h4>${student.full_name}</h4>
                                <p>${student.student_id} ‚Ä¢ ${student.class_grade}</p>
                            </div>
                            <div class="house-indicator ${student.house_team}"></div>
                        </div>
                        <div class="student-stats">
                            <div class="student-stat">
                                <div class="student-stat-value">${student.house_points || 0}</div>
                                <div class="student-stat-label">House Points</div>
                            </div>
                            <div class="student-stat">
                                <div class="student-stat-value">${student.avatar_level || 1}</div>
                                <div class="student-stat-label">Avatar Level</div>
                            </div>
                            <div class="student-stat">
                                <div class="student-stat-value">85%</div>
                                <div class="student-stat-label">Progress</div>
                            </div>
                            <div class="student-stat">
                                <div class="student-stat-value">12</div>
                                <div class="student-stat-label">Assessments</div>
                            </div>
                        </div>
                    `;
                    
                    studentCard.addEventListener('click', () => {
                        showStudentDetail(student);
                    });
                    
                    studentsGrid.appendChild(studentCard);
                });
            }, 500);
        }

        function generateSampleStudents(count = null) {
            // Create a test class "1B" labelled as TEST with 10-15 students by default
            const min = 10, max = 15;
            const n = Number.isInteger(count) && count > 0 ? count : Math.floor(Math.random() * (max - min + 1)) + min;
            const houses = ['red', 'green', 'yellow', 'blue'];
            const students = [];
            const sampleNames = [
                'Emma Johnson', 'Liam Smith', 'Olivia Brown', 'Noah Davis', 'Ava Wilson',
                'Ethan Moore', 'Sophia Taylor', 'Mason Anderson', 'Isabella Thomas', 'William Jackson',
                'Mia White', 'James Harris', 'Charlotte Martin', 'Benjamin Thompson', 'Amelia Garcia',
                'Lucas Robinson', 'Harper Clark', 'Henry Lewis', 'Evelyn Walker', 'Alexander Young'
            ];
            for (let i = 1; i <= n; i++) {
                const house = houses[Math.floor(Math.random() * houses.length)];
                const points = Math.floor(Math.random() * 201); // 0..200
                let name = sampleNames[(i - 1) % sampleNames.length];
                // If there are more students than sample names, append index to keep unique
                if (i > sampleNames.length) name = `${name} ${i}`;
                const stu = {
                    user_type: 'student',
                    id: `test-1B-${i}`,
                    studentId: `1B-${String(i).padStart(2, '0')}`,
                    student_id: `1B-${String(i).padStart(2, '0')}`,
                    fullName: name,
                    full_name: name,
                    name: name,
                    email: `test1b${i}@example.com`,
                    class: '1B',
                    class_grade: '1B',
                    // `className` will be used in the UI (leaderboard/profile).
                    // Keep a separate marker `class_label` to indicate these are test students.
                    className: '1B',
                    class_label: 'TEST',
                    house: house,
                    house_team: house,
                    house_points: points,
                    points: points,
                    avatar_level: Math.min(20, Math.floor(points / 10) + 1),
                    avatarLevel: Math.min(20, Math.floor(points / 10) + 1),
                    profile_photo: null,
                    gender: Math.random() > 0.5 ? 'male' : 'female'
                };
                students.push(stu);
            }

            // Merge with existing users: remove previous 1B TEST entries first
            try {
                const existing = JSON.parse(localStorage.getItem('users') || '[]');
                const filtered = (existing || []).filter(u => !(u && (u.class === '1B' || u.class_grade === '1B' || u.class_label === 'TEST')));
                const merged = filtered.concat(students);
                localStorage.setItem('users', JSON.stringify(merged));
                userData = merged.slice();
            } catch (e) {
                localStorage.setItem('users', JSON.stringify(students));
                userData = students.slice();
            }
            return students;
        }

        // Expose helpers so you can control test data from console or UI
        window.generateTestClass = function (count) {
            const arr = generateSampleStudents(count);
            try { populateLeaderboard(); } catch (e) { /* ignore */ }
            return arr;
        };

        window.clearTestStudents = function () {
            try {
                const existing = JSON.parse(localStorage.getItem('users') || '[]');
                const filtered = (existing || []).filter(u => !(u && (u.class === '1B' || u.class_grade === '1B' || u.class_label === 'TEST')));
                localStorage.setItem('users', JSON.stringify(filtered));
                userData = filtered.slice();
                try { populateLeaderboard(); } catch (e) {}
                return filtered;
            } catch (e) {
                return [];
            }
        };

        async function loadAssessmentData() {
            const assessmentGrid = document.getElementById('assessmentGrid');
            const selectedClass = document.getElementById('assessmentClassFilter')?.value || '';
            const selectedSport = document.getElementById('assessmentSportFilter')?.value || '';
            
            assessmentGrid.innerHTML = '<div class="loading"><div class="spinner"></div>Loading assessments...</div>';
            
            // Filter students for assessment
            const studentsForAssessment = userData.filter(student => 
                student.user_type === 'student' && 
                (selectedClass === '' || student.class_grade === selectedClass)
            );

            const sampleStudents = studentsForAssessment.length > 0 ? studentsForAssessment : generateSampleStudents();
            
            setTimeout(() => {
                assessmentGrid.innerHTML = '';
                
                sampleStudents.slice(0, 6).forEach(student => {
                    const assessmentItem = document.createElement('div');
                    assessmentItem.className = 'assessment-item';
                    assessmentItem.innerHTML = `
                        <div class="assessment-student-header">
                            <div class="student-photo">
                                ${student.profile_photo ? `<img src="${student.profile_photo}" alt="${student.full_name}">` : 'üë§'}
                            </div>
                            <div class="student-info">
                                <h4>${student.full_name}</h4>
                                <p>${student.student_id} ‚Ä¢ ${student.class_grade} ‚Ä¢ ${student.house_team.charAt(0).toUpperCase() + student.house_team.slice(1)} House</p>
                            </div>
                        </div>
                        
                        <div class="skills-evaluation">
                            <div class="skill-input">
                                <label>Motor Skill 1 (0-4)</label>
                                <input type="number" min="0" max="4" value="0" onchange="updateSkillTotal(this)">
                            </div>
                            <div class="skill-input">
                                <label>Motor Skill 2 (0-4)</label>
                                <input type="number" min="0" max="4" value="0" onchange="updateSkillTotal(this)">
                            </div>
                            <div class="skill-input">
                                <label>Motor Skill 3 (0-4)</label>
                                <input type="number" min="0" max="4" value="0" onchange="updateSkillTotal(this)">
                            </div>
                            <div class="skill-input">
                                <label>Methodology (0-4)</label>
                                <input type="number" min="0" max="4" value="0" onchange="updateSkillTotal(this)">
                            </div>
                            <div class="skill-input">
                                <label>Social Skills (0-4)</label>
                                <input type="number" min="0" max="4" value="0" onchange="updateSkillTotal(this)">
                            </div>
                        </div>
                        
                        <div class="total-score">
                            <div class="total-score-value">0/20</div>
                            <div>Total House Points</div>
                        </div>
                        
                        <button class="save-assessment-btn" onclick="saveTeacherAssessment('${student.student_id}', this)">
                            Save Skills Assessment
                        </button>
                    `;
                    
                    assessmentGrid.appendChild(assessmentItem);
                });
            }, 500);
        }

        function updateSkillTotal(input) {
            const assessmentItem = input.closest('.assessment-item');
            const skillInputs = assessmentItem.querySelectorAll('.skill-input input');
            let total = 0;
            
            skillInputs.forEach(skillInput => {
                total += parseInt(skillInput.value) || 0;
            });
            
            const totalDisplay = assessmentItem.querySelector('.total-score-value');
            totalDisplay.textContent = `${total}/20`;
        }

        async function saveTeacherAssessment(studentId, button) {
            const assessmentItem = button.closest('.assessment-item');
            const skillInputs = assessmentItem.querySelectorAll('.skill-input input');
            const skills = Array.from(skillInputs).map(input => parseInt(input.value) || 0);
            const total = skills.reduce((sum, skill) => sum + skill, 0);
            
            button.disabled = true;
            button.textContent = 'Saving...';
            
            // Save teacher assessment
            if (window.dataSdk) {
                const assessmentRecord = {
                    user_id: `teacher_assessment_${studentId}_${Date.now()}`,
                    student_id: studentId,
                    teacher_name: currentUser.full_name,
                    sport: 'basketball', // Default for demo
                    motor_skill_1: skills[0],
                    motor_skill_2: skills[1],
                    motor_skill_3: skills[2],
                    methodology: skills[3],
                    social_skills: skills[4],
                    total_points: total,
                    assessment_type: 'teacher_skills',
                    created_at: new Date().toISOString()
                };

                const result = await window.dataSdk.create(assessmentRecord);
                if (result.isOk) {
                    // Update student's house points
                    const studentRecord = userData.find(record => record.student_id === studentId);
                    if (studentRecord) {
                        const newHousePoints = (studentRecord.house_points || 0) + total;
                        await window.dataSdk.update({
                            ...studentRecord,
                            house_points: newHousePoints
                        });
                    }
                    
                    showNotification(`Assessment saved! ${total} house points awarded.`, 'success');
                } else {
                    showNotification('Failed to save assessment', 'error');
                }
            }
            
            button.disabled = false;
            button.textContent = 'Save Skills Assessment';
        }

        async function loadStudentDetails() {
            const studentDetailsGrid = document.getElementById('studentDetailsGrid');
            
            studentDetailsGrid.innerHTML = '<div class="loading"><div class="spinner"></div>Loading student data...</div>';
            
            const allStudents = userData.filter(student => student.user_type === 'student');
            const sampleStudents = allStudents.length > 0 ? allStudents : generateSampleStudents();
            
            setTimeout(() => {
                studentDetailsGrid.innerHTML = '';
                
                sampleStudents.slice(0, 8).forEach(student => {
                    const studentDetailCard = document.createElement('div');
                    studentDetailCard.className = 'student-detail-card';
                    studentDetailCard.innerHTML = `
                        <div class="student-detail-header">
                            <div class="student-detail-photo">
                                ${student.profile_photo ? `<img src="${student.profile_photo}" alt="${student.full_name}">` : 'üë§'}
                            </div>
                            <div class="student-info">
                                <h4>${student.full_name}</h4>
                                <p>${student.student_id} ‚Ä¢ ${student.class_grade}</p>
                                <p>${student.house_team.charAt(0).toUpperCase() + student.house_team.slice(1)} House</p>
                            </div>
                        </div>
                        
                        <div class="student-progress-section">
                            <h4>Assessment Progress</h4>
                            <div class="progress-items">
                                <div class="progress-item">
                                    <span class="progress-item-name">Self-Assessments</span>
                                    <span class="progress-item-value">8/10</span>
                                </div>
                                <div class="progress-item">
                                    <span class="progress-item-name">Skills Evaluations</span>
                                    <span class="progress-item-value">6/10</span>
                                </div>
                                <div class="progress-item">
                                    <span class="progress-item-name">Quiz Levels</span>
                                    <span class="progress-item-value">15/100</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="student-progress-section">
                            <h4>Performance Stats</h4>
                            <div class="progress-items">
                                <div class="progress-item">
                                    <span class="progress-item-name">House Points</span>
                                    <span class="progress-item-value">${student.house_points || 0}</span>
                                </div>
                                <div class="progress-item">
                                    <span class="progress-item-name">Avatar Level</span>
                                    <span class="progress-item-value">${student.avatar_level || 1}</span>
                                </div>
                                <div class="progress-item">
                                    <span class="progress-item-name">Overall Progress</span>
                                    <span class="progress-item-value">75%</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    studentDetailsGrid.appendChild(studentDetailCard);
                });
            }, 500);
        }

        function searchStudents() {
            const searchTerm = document.getElementById('studentSearchInput').value.toLowerCase();
            const studentCards = document.querySelectorAll('.student-detail-card');
            
            studentCards.forEach(card => {
                const studentName = card.querySelector('h4').textContent.toLowerCase();
                const studentId = card.querySelector('p').textContent.toLowerCase();
                
                if (studentName.includes(searchTerm) || studentId.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function showStudentDetail(student) {
            showNotification(`Viewing detailed profile for ${student.full_name}`, 'info');
        }

        // Report Generation Functions
        function generateClassReport() {
            const selectedClass = document.getElementById('reportClassSelect').value;
            if (!selectedClass) {
                showNotification('Please select a class first', 'error');
                return;
            }
            
            const reportPreview = document.getElementById('reportPreview');
            reportPreview.innerHTML = `
                <h3 style="color: var(--text-light); margin-bottom: 1rem;">Class Progress Report - ${selectedClass}</h3>
                <div style="color: var(--text-secondary); line-height: 1.6;">
                    <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
                    <p><strong>Total Students:</strong> 24</p>
                    <p><strong>Average House Points:</strong> 28.5</p>
                    <p><strong>Assessment Completion:</strong> 87%</p>
                    <p><strong>Top Performers:</strong> Emma Johnson (45 pts), Liam Smith (42 pts)</p>
                    <p><strong>Areas for Improvement:</strong> Motor skills development, Quiz participation</p>
                </div>
            `;
            
            showNotification('Class report generated successfully!', 'success');
        }

        function generateStudentReport() {
            showNotification('Individual student reports coming soon!', 'info');
        }

        function generateHouseReport() {
            const reportPreview = document.getElementById('reportPreview');
            reportPreview.innerHTML = `
                <h3 style="color: var(--text-light); margin-bottom: 1rem;">House Points Summary Report</h3>
                <div style="color: var(--text-secondary); line-height: 1.6;">
                    <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
                    <p><strong>Current Standings:</strong></p>
                    <ul style="margin: 1rem 0; padding-left: 2rem;">
                        <li>ü•á Yellow House: 1,320 points (48 students)</li>
                        <li>ü•à Blue House: 1,290 points (46 students)</li>
                        <li>ü•â Red House: 1,250 points (45 students)</li>
                        <li>4th Green House: 1,180 points (42 students)</li>
                    </ul>
                    <p><strong>Average per Student:</strong> Yellow: 27.5, Blue: 28.0, Red: 27.8, Green: 28.1</p>
                </div>
            `;
            
            showNotification('House report generated successfully!', 'success');
        }

        function exportClassReport() {
            showNotification('PDF export functionality coming soon!', 'info');
        }

        function exportStudentReport() {
            showNotification('PDF export functionality coming soon!', 'info');
        }

        function exportHouseReport() {
            showNotification('PDF export functionality coming soon!', 'info');
        }

        // Toggle between student registration and login forms
        function toggleAuthForms(mode) {
            const studentForm = document.getElementById('studentForm');
            const studentLogin = document.getElementById('studentLoginForm');
            const teacherForm = document.getElementById('teacherForm');
            const toLoginBtn = document.getElementById('toStudentLoginBtn');
            const toRegBtn = document.getElementById('toStudentRegisterBtn');

            if (mode === 'studentLogin') {
                if (studentForm) studentForm.classList.add('hidden');
                if (studentLogin) studentLogin.classList.remove('hidden');
                if (teacherForm) teacherForm.classList.add('hidden');
                if (toLoginBtn) toLoginBtn.style.display = 'none';
                if (toRegBtn) toRegBtn.style.display = 'inline-block';
            } else if (mode === 'studentRegister') {
                if (studentForm) studentForm.classList.remove('hidden');
                if (studentLogin) studentLogin.classList.add('hidden');
                if (toLoginBtn) toLoginBtn.style.display = 'inline-block';
                if (toRegBtn) toRegBtn.style.display = 'none';
            }
        }

        // Simple student login handler: matches email + studentId against stored users
        async function handleStudentLogin(e) {
            e.preventDefault();
            const email = (document.getElementById('studentLoginEmail') || {}).value || '';
            const studentId = (document.getElementById('studentLoginId') || {}).value || '';
            const password = (document.getElementById('studentLoginPassword') || {}).value || '';

            // try in-memory `userData` first, then localStorage fallback
            let users = Array.isArray(userData) && userData.length ? userData : [];
            try {
                const stored = JSON.parse(localStorage.getItem('users') || '[]');
                if (Array.isArray(stored) && stored.length) users = stored;
            } catch (err) {
                // ignore parse errors
            }

            const found = users.find(u => {
                const uEmail = (u.email || '').toLowerCase();
                const uId = (u.studentId || u.studentID || u.student_id || u.id || '').toString();
                return uEmail === email.toLowerCase() && uId === studentId.toString();
            });

            if (found) {
                // verify password if present
                if (found.password && password && found.password === password) {
                    currentUser = found;
                    currentUserType = 'student';
                    showNotification(`Welcome back, ${found.fullName || found.name || 'Student'}!`, 'success');
                    setTimeout(() => showMainApp(), 600);
                } else if (!found.password) {
                    // legacy account without password, allow login by id+email
                    currentUser = found;
                    currentUserType = 'student';
                    showNotification(`Welcome back, ${found.fullName || found.name || 'Student'}! (no password set)`, 'info');
                    setTimeout(() => showMainApp(), 600);
                } else {
                    showNotification('Invalid password. Please try again.', 'error');
                }
            } else {
                showNotification('Invalid credentials. Please check your email and Student ID.', 'error');
            }
        }

        // Populate leaderboard panel with house totals and top students
        function populateLeaderboard() {
            const container = document.getElementById('leaderboardTab');
            if (!container) return;
            let students = [];
            if (Array.isArray(userData) && userData.length) {
                students = userData.slice();
            } else {
                try {
                    students = JSON.parse(localStorage.getItem('users') || '[]') || [];
                } catch (e) {
                    students = [];
                }
            }
            if (!students.length && typeof generateSampleStudents === 'function') {
                const generated = generateSampleStudents();
                if (Array.isArray(generated) && generated.length) students = generated;
            }
            const houseKeys = ['red','green','yellow','blue'];
            const houses = Object.fromEntries(houseKeys.map(k => [k, {key:k, total:0, students:[]} ]));
            students.forEach(s => {
                const house = (s.house || s.house_color || (s.studentHouse||'') ).toString().toLowerCase();
                const points = Number(s.house_points ?? s.points ?? 0) || 0;
                const name = s.fullName || s.name || s.displayName || s.email || ('Student ' + (s.studentId || ''));
                if (houses[house]) {
                    houses[house].total += points;
                    const classLabel = s.className || s.class || s.class_grade || s.class_label || '';
                    houses[house].students.push({ name, points, id: s.studentId || s.id, className: classLabel });
                }
            });
            // sort houses by total points desc
            const houseOrder = Object.values(houses).sort((a,b)=> b.total - a.total);
            const html = houseOrder.map(h => {
                const colorClass = 'house-card ' + h.key;
                const top = h.students.sort((a,b)=> b.points - a.points).slice(0,3);
                const studentsList = top.length ? '<ol style="text-align:left;margin:0;padding-left:1rem;">' + top.map(st => {
                    const cls = st.className ? ` (${escapeHtml(st.className)})` : '';
                    return `<li>${escapeHtml(st.name)}${cls} ‚Äî <strong>${st.points}</strong></li>`;
                }).join('') + '</ol>' : '<div style="text-align:left;color:#666">No students yet</div>';
                return `<div class="${colorClass}">
                            <div class="house-name">${h.key.charAt(0).toUpperCase() + h.key.slice(1)} House</div>
                            <div class="house-total">${h.total}</div>
                            <div style="margin-top:0.5rem;">${studentsList}</div>
                        </div>`;
            }).join('');
            container.innerHTML = `<div class="house-leaderboard" style="grid-template-columns:repeat(4,1fr);gap:1rem;">${html}</div>`;
        }

        // Wire up auth switch buttons and login form after DOM ready
        document.addEventListener('DOMContentLoaded', function () {
            const toLogin = document.getElementById('toStudentLoginBtn');
            const toReg = document.getElementById('toStudentRegisterBtn');
            const studentLoginForm = document.getElementById('studentLoginForm');

            if (toLogin) toLogin.addEventListener('click', () => toggleAuthForms('studentLogin'));
            if (toReg) toReg.addEventListener('click', () => toggleAuthForms('studentRegister'));
            if (studentLoginForm) studentLoginForm.addEventListener('submit', handleStudentLogin);
        });

        // Initialize the application and refresh leaderboard after init
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp().then(() => {
                try {
                    if (typeof generateTestClass === 'function') {
                        // create class 1B now for testing
                        generateTestClass();
                    }
                } catch (e) { console.warn('generateTestClass failed', e); }
                try { populateLeaderboard(); } catch (e) { console.warn('populateLeaderboard failed', e); }
            }).catch(() => {
                try { populateLeaderboard(); } catch (e) { console.warn('populateLeaderboard failed', e); }
            });
        });

        /* ====== Quiz Map, Quiz Bank (100 quizzes) and Quiz Flow ======
           - 100 quizzes organized into 10 levels (10 each)
           - Reading page (Title, Quote, Main Text) before quiz
           - 10-question MCQ per quiz, questions derived from mainText
           - 'Read Topic Text' overlay available during questions
           - Reward quizzes: quizzes with index ending in 5 or 0
           - House point awarding on passing reward quizzes
        */

        // Quiz state
        const QUIZ_LEVELS = 10;
        const QUIZZES_PER_LEVEL = 10;
        let quizBank = [];
        let activeQuiz = null; // { index, quiz, answers, score }

        function buildQuizBank() {
            // Define 10 core topics mapped to levels 1..10 (each level covers one topic across its 10 quizzes)
            const TOPIC_DEFS = [
                {
                    key: 'Sport Rules',
                    quote: 'You have to play by the rules ‚Äî sportsmanship is everything. ‚Äî Billie Jean King',
                    subtopics: [
                        'Introduction to rules and why they exist',
                        'How rules keep competition fair',
                        'Common rule examples in team sports',
                        'Referees and officials: roles and signals',
                        'Penalties and fair sanctions',
                        'Adapting rules for younger players',
                        'Rule changes and game evolution',
                        'How rules protect player safety',
                        'Applying rules in practice and matches',
                        'Dispute resolution and fair decisions'
                    ]
                },
                {
                    key: 'Sport Values',
                    quote: 'The important thing in life is not the triumph but the struggle. ‚Äî Pierre de Coubertin',
                    subtopics: [
                        'Respect and humility',
                        'Determination and resilience',
                        'Teamwork and cooperation',
                        'Honesty and integrity',
                        'Effort and commitment',
                        'Respect for opponents',
                        'Leadership through example',
                        'Responsibility to the team',
                        'Celebrating success and learning from loss',
                        'Community and inclusion in sport'
                    ]
                },
                {
                    key: 'Safety in Sport',
                    quote: 'An ounce of prevention is worth a pound of cure. ‚Äî Benjamin Franklin',
                    subtopics: [
                        'Warm-up and cool-down importance',
                        'Correct equipment and protective gear',
                        'Playing surface and environment checks',
                        'Recognising and managing fatigue',
                        'Basic on-field safety rules',
                        'Hydration and rest to prevent harm',
                        'Reporting hazards and fixing them',
                        'Supervision and qualified coaching',
                        'Safe practice progression',
                        'Return-to-play considerations after injury'
                    ]
                },
                {
                    key: 'History of Sports',
                    quote: 'Sport has the power to change the world. ‚Äî Nelson Mandela',
                    subtopics: [
                        'Origins of ancient games',
                        'Modern Olympics beginnings',
                        'Evolution of team sports',
                        'Historic athletes who changed their sports',
                        'How rules and equipment evolved',
                        'Women in sport: a timeline',
                        'Globalisation of sports and leagues',
                        'Iconic sporting moments',
                        'The role of sport in society',
                        'How sport reflects cultural change'
                    ]
                },
                {
                    key: 'Nutrition - Fuel for the Body',
                    quote: 'If you don‚Äôt take care of your body, where are you going to live? ‚Äî Unknown',
                    subtopics: [
                        'Macronutrients: carbs, proteins, fats',
                        'Pre-training snacks and meals',
                        'Recovery meals after exercise',
                        'Importance of balanced hydration',
                        'Timing meals for performance',
                        'Energy needs for growing athletes',
                        'Healthy snack choices',
                        'Role of vitamins and minerals',
                        'Reducing processed foods before competition',
                        'Reading simple nutrition labels'
                    ]
                },
                {
                    key: 'Anatomy & Movement',
                    quote: 'To move well is to live well. ‚Äî Anonymous',
                    subtopics: [
                        'Major muscle groups used in sport',
                        'Basic joint actions (flexion/extension)',
                        'Posture and alignment for performance',
                        'How muscles work together in movement',
                        'Simple biomechanics of running and jumping',
                        'Body awareness and proprioception',
                        'Common movement faults to avoid',
                        'Mobility vs flexibility',
                        'Why technique matters',
                        'Injury mechanisms related to poor movement'
                    ]
                },
                {
                    key: 'Training Principles',
                    quote: 'The only place where success comes before work is in the dictionary. ‚Äî Vidal Sassoon',
                    subtopics: [
                        'Progressive overload and adaptation',
                        'Specificity: training for the sport',
                        'Recovery and rest planning',
                        'Periodisation basics for young athletes',
                        'Consistency and gradual progression',
                        'Measuring improvement',
                        'Cross-training benefits',
                        'Balance of strength and skill work',
                        'Setting realistic goals',
                        'Avoiding overtraining'
                    ]
                },
                {
                    key: 'Psychology of Sport',
                    quote: 'Champions keep playing until they get it right. ‚Äî Billie Jean King',
                    subtopics: [
                        'Goal-setting and motivation',
                        'Managing competition anxiety',
                        'Concentration and focus techniques',
                        'The role of self-talk',
                        'Team cohesion and communication',
                        'Handling pressure moments',
                        'Building confidence through practice',
                        'Visualization and mental rehearsal',
                        'Growth mindset vs fixed mindset',
                        'Support networks and mentoring'
                    ]
                },
                {
                    key: 'Fair Play & Ethics',
                    quote: 'Winning isn‚Äôt everything, but wanting to win is. ‚Äî Vince Lombardi',
                    subtopics: [
                        'Definition of fair play',
                        'Respecting opponents and officials',
                        'Doping and ethical behaviour',
                        'Inclusive sport and anti-discrimination',
                        'Consequences of cheating',
                        'Sportsmanship examples in behaviour',
                        'Reporting unethical conduct',
                        'Role models and responsibility',
                        'Fair selection and equal opportunity',
                        'Creating a positive culture in sport'
                    ]
                },
                {
                    key: 'Olympics & Major Events',
                    quote: 'The Olympic Games are more than a sporting event; they are a celebration. ‚Äî Jacques Rogge',
                    subtopics: [
                        'History and values of the Olympics',
                        'How athletes qualify',
                        'Hosting challenges and legacy',
                        'Memorable Olympic moments',
                        'Para-sport and inclusion',
                        'Opening and closing ceremony roles',
                        'Medals and records significance',
                        'National pride and international friendship',
                        'The Olympic movement and symbols',
                        'Career paths after major events'
                    ]
                }
            ];

            quizBank = [];
            let qIndex = 1;
            for (let level = 1; level <= QUIZ_LEVELS; level++) {
                // select topic by level index (level 1 -> TOPIC_DEFS[0], level 2 -> [1], ...)
                const topicDef = TOPIC_DEFS[(level - 1) % TOPIC_DEFS.length];
                for (let i = 1; i <= QUIZZES_PER_LEVEL; i++) {
                    const variant = (i - 1) % 10; // choose a subtopic variant 0..9
                    const title = `${topicDef.key} ‚Äî ${topicDef.subtopics[variant]}`;
                    const quote = topicDef.quote;

                    // Compose a 3-paragraph main text using the chosen subtopic
                    const para1 = `${topicDef.key}: ${topicDef.subtopics[variant]}. This section introduces the idea and explains why it matters for young learners in PE.`;
                    const para2 = `Details: In practical terms, ${topicDef.subtopics[variant].toLowerCase()} includes key points students should remember. Examples: ${generateExamples(topicDef.key, variant)}.`;
                    const para3 = `Takeaway: Remember that ${topicDef.subtopics[variant].toLowerCase()} helps athletes perform better and stay safe. Teachers and coaches emphasise practice, correct technique and respect for others.`;
                    const mainText = `${para1}\n\n${para2}\n\n${para3}`;

                    // Produce 10 MCQs: use clear statements drawn from the mainText sentences
                    const sentences = mainText.split(/\.\s+/).map(s => s.trim()).filter(s => s.length > 15);
                    const questions = [];
                    for (let q = 0; q < 10; q++) {
                        const correctSentence = sentences[q % sentences.length];
                        // Build distractors by altering key words or using neighboring sentences
                        const distractors = [];
                        // Neighboring sentences
                        const n1 = sentences[(q + 1) % sentences.length] || sentences[0];
                        const n2 = sentences[(q + 2) % sentences.length] || sentences[0];
                        distractors.push(n1);
                        distractors.push(n2);
                        // A simple altered sentence as another distractor
                        distractors.push(correctSentence.replace(/\b(is|are|includes|helps|remember)\b/gi, 'may'));

                        // assemble options and ensure unique
                        const options = [correctSentence].concat(distractors).slice(0,4).map(s => s.trim());
                        // shuffle deterministic-ish using qIndex + q
                        for (let s = options.length -1; s > 0; s--) {
                            const r = (qIndex + q + s) % (s + 1);
                            [options[s], options[r]] = [options[r], options[s]];
                        }
                        questions.push({
                            id: `${qIndex}_${q+1}`,
                            question: `Which statement best reflects the passage above?`,
                            options: options,
                            correct: options.indexOf(correctSentence)
                        });
                    }

                    quizBank.push({
                        index: qIndex,
                        level: level,
                        title: title,
                        quote: quote,
                        mainText: mainText,
                        questions: questions,
                        isReward: (qIndex % 5 === 0)
                    });

                    qIndex++;
                }
            }

            // helper to generate short example phrases based on topic and variant
            function generateExamples(topicKey, variantIndex) {
                const examplesMap = {
                    'Sport Rules': ['stopping play at whistle', 'no elbowing', 'respecting throw-in procedures'],
                    'Sport Values': ['supporting teammates', 'applauding opponents', 'accepting referee decisions'],
                    'Safety in Sport': ['wearing shin guards', 'checking footwear', 'clearing debris from the pitch'],
                    'History of Sports': ['ancient Olympic origins', 'first modern marathons', 'early rules codification'],
                    'Nutrition - Fuel for the Body': ['carbohydrates before matches', 'protein for recovery', 'snacks like bananas or yogurt'],
                    'Anatomy & Movement': ['using quads for running', 'core stability for balance', 'ankle mobility drills'],
                    'Training Principles': ['gradual increase of load', 'mixing skill sessions with fitness', 'rest days within programmes'],
                    'Psychology of Sport': ['setting small goals', 'deep breathing to focus', 'positive self-talk routines'],
                    'Fair Play & Ethics': ['no intentional fouling', 'anti-doping rules', 'equal play opportunities'],
                    'Olympics & Major Events': ['medal ceremonies', 'hosting city legacy', 'opening ceremony traditions']
                };
                const list = examplesMap[topicKey] || ['practical example 1', 'practical example 2', 'practical example 3'];
                return list[variantIndex % list.length];
            }
        }

        function populateQuizMap() {
            const container = document.getElementById('quizMap');
            if (!container) return;
            // clear
            container.innerHTML = '';
            for (let level = 1; level <= QUIZ_LEVELS; level++) {
                const levelDiv = document.createElement('div');
                levelDiv.className = 'quiz-level-row';
                levelDiv.style.margin = '0.5rem 0';
                const header = document.createElement('div');
                header.style.margin = '0.25rem 0';
                header.innerHTML = `<strong style="color:var(--accent-primary)">Level ${level}</strong>`;
                levelDiv.appendChild(header);

                const grid = document.createElement('div');
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = 'repeat(10, 1fr)';
                grid.style.gap = '0.5rem';

                const start = (level -1) * QUIZZES_PER_LEVEL + 1;
                const end = start + QUIZZES_PER_LEVEL -1;
                for (let qi = start; qi <= end; qi++) {
                    const btn = document.createElement('button');
                    btn.className = 'quiz-point';
                    btn.dataset.quizIndex = qi;
                    btn.style.padding = '0.5rem';
                    btn.style.borderRadius = '6px';
                    btn.style.border = '1px solid rgba(255,255,255,0.08)';
                    btn.style.background = 'rgba(255,255,255,0.03)';
                    btn.style.color = 'white';
                    btn.style.cursor = 'pointer';
                    btn.textContent = qi;
                    // reward quiz styling (read from quizBank when available)
                    const quizObj = quizBank.find(q => q.index === qi);
                    if (quizObj && quizObj.isReward) {
                        btn.style.background = 'linear-gradient(90deg, #ffd54f, #ffc107)';
                        btn.style.color = '#222';
                        btn.title = 'High-Value Quiz ‚Äî reward available';
                        btn.classList.add('quiz-reward');
                    }
                    btn.addEventListener('click', () => openQuizEntry(qi));
                    grid.appendChild(btn);
                }
                levelDiv.appendChild(grid);
                container.appendChild(levelDiv);
            }
        }

        function openQuizEntry(index) {
            const quiz = quizBank.find(q => q.index === Number(index));
            if (!quiz) return;
            // render reading page into quizLevelView
            const view = document.getElementById('quizLevelView');
            if (!view) return;
            // populate intro area
            const headerTitle = document.getElementById('quizLevelTitle');
            const intro = document.getElementById('quizIntro');
            headerTitle.textContent = quiz.title;
            const specialStyle = quiz.isReward ? 'box-shadow:0 8px 24px rgba(255,193,7,0.18);border:3px solid #ffecb3' : '';
            intro.innerHTML = `
                <div style="padding:1rem;background:var(--surface-light);border-radius:12px;color:var(--text-light);max-height:220px;overflow:auto;${specialStyle}">
                    <h3 style="margin-bottom:0.5rem">${quiz.title}</h3>
                    <blockquote style="font-style:italic;color:var(--text-secondary);">${quiz.quote}</blockquote>
                    <div style="margin-top:1rem;max-height:220px;overflow:auto;color:var(--text-light);white-space:pre-wrap">${escapeHtml(quiz.mainText)}</div>
                    <div style="text-align:right;margin-top:1rem;"><button id="startQuizBtn" class="quiz-btn">Start Quiz</button></div>
                </div>
            `;
            // show view
            switchTab('quiz');
            // attach start handler
            setTimeout(()=>{
                const b = document.getElementById('startQuizBtn');
                if (b) b.addEventListener('click', () => startQuiz(quiz.index));
            }, 50);
        }

        // Overlay for reading topic text during quiz
        function showReadOverlay(quiz) {
            const existing = document.getElementById('quizReadOverlay');
            if (existing) existing.remove();
            const overlay = document.createElement('div');
            overlay.id = 'quizReadOverlay';
            overlay.style.position = 'fixed';
            overlay.style.top = 0;
            overlay.style.left = 0;
            overlay.style.right = 0;
            overlay.style.bottom = 0;
            overlay.style.background = 'rgba(0,0,0,0.7)';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.zIndex = 9999;
            overlay.innerHTML = `
                <div style="max-width:900px;width:90%;background:var(--surface-light);border-radius:12px;padding:1rem;color:var(--text-light);max-height:90%;overflow:auto;">
                    <h3>${escapeHtml(quiz.title)}</h3>
                    <blockquote style="font-style:italic;color:var(--text-secondary)">${escapeHtml(quiz.quote)}</blockquote>
                    <div style="white-space:pre-wrap;margin-top:0.5rem">${escapeHtml(quiz.mainText)}</div>
                    <div style="text-align:right;margin-top:1rem"><button id="closeQuizRead" class="quiz-btn">Close</button></div>
                </div>
            `;
            document.body.appendChild(overlay);
            document.getElementById('closeQuizRead')?.addEventListener('click', ()=> overlay.remove());
        }

        function startQuiz(index) {
            const quiz = quizBank.find(q => q.index === Number(index));
            if (!quiz) return;
            activeQuiz = { index: quiz.index, quiz, currentQuestion: 0, answers: Array(10).fill(null), score: 0 };
            // show question UI
            renderQuestion();
        }

        function renderQuestion() {
            if (!activeQuiz) return;
            const qIdx = activeQuiz.currentQuestion;
            const questionObj = activeQuiz.quiz.questions[qIdx];
            // prepare question container
            const container = document.getElementById('quizQuestionContainer');
            if (!container) return;
            container.innerHTML = '';
            const qWrap = document.createElement('div');
            qWrap.style.padding = '1rem';
            qWrap.style.background = 'var(--surface-light)';
            qWrap.style.borderRadius = '12px';
            qWrap.style.color = 'var(--text-light)';

            qWrap.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <div><strong>Question ${qIdx + 1} of 10</strong></div>
                    <div><button id="readTopicBtn" class="quiz-btn secondary">Read Topic Text</button></div>
                </div>
                <div style="margin-bottom:1rem;font-weight:600">${escapeHtml(questionObj.question)}</div>
                <div id="optionsList"></div>
                <div style="text-align:right;margin-top:1rem;"><button id="nextQBtn" class="quiz-btn" disabled>Next</button></div>
            `;
            container.appendChild(qWrap);
            const optionsList = document.getElementById('optionsList');
            questionObj.options.forEach((opt, oi) => {
                const el = document.createElement('div');
                el.className = 'answer-option';
                el.style.marginBottom = '0.5rem';
                el.innerHTML = `<div style="display:flex;gap:0.75rem;align-items:center"><div style="width:30px;height:30px;border-radius:50%;background:var(--accent-primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:700">${String.fromCharCode(65+oi)}</div><div style="flex:1">${escapeHtml(opt)}</div></div>`;
                el.addEventListener('click', ()=> {
                    // mark selection
                    activeQuiz.answers[qIdx] = oi;
                    // mark visual
                    document.querySelectorAll('#optionsList .answer-option').forEach(a => a.style.borderColor = 'transparent');
                    el.style.border = '2px solid var(--accent-primary)';
                    document.getElementById('nextQBtn').disabled = false;
                });
                optionsList.appendChild(el);
            });

            document.getElementById('readTopicBtn').addEventListener('click', ()=> showReadOverlay(activeQuiz.quiz));

            document.getElementById('nextQBtn').addEventListener('click', ()=> {
                // if answer exists, evaluate
                const ans = activeQuiz.answers[qIdx];
                if (ans !== null) {
                    if (ans === questionObj.correct) activeQuiz.score += 1;
                }
                // advance
                if (qIdx + 1 < 10) {
                    activeQuiz.currentQuestion++;
                    renderQuestion();
                } else {
                    // finish
                    finishQuiz();
                }
            });
        }

        function finishQuiz() {
            if (!activeQuiz) return;
            // final score already accumulated for previous answers except possibly last one
            const lastIdx = activeQuiz.currentQuestion;
            const lastQuestion = activeQuiz.quiz.questions[lastIdx];
            const lastAns = activeQuiz.answers[lastIdx];
            if (lastAns !== null && lastAns === lastQuestion.correct) activeQuiz.score += 1;

            const correct = activeQuiz.score;
            const percent = Math.round((correct / 10) * 100);
            const pass = percent >= 70; // passing threshold

            // mark completed quiz level in currentUser
            try {
                if (!currentUser) currentUser = JSON.parse(localStorage.getItem('peHubUser') || 'null');
            } catch (e) {}
            if (currentUser) {
                if (!Array.isArray(currentUser.completed_quiz_levels)) currentUser.completed_quiz_levels = [];
                if (!currentUser.completed_quiz_levels.includes(activeQuiz.index)) currentUser.completed_quiz_levels.push(activeQuiz.index);
            }

            // if this quiz is reward quiz (marked in quizBank) and passed, award 1 house point
            const isReward = (activeQuiz.quiz && activeQuiz.quiz.isReward) || (activeQuiz.index % 5 === 0);
            let awardedPoint = false;
            if (isReward && pass && currentUser) {
                currentUser.house_points = (Number(currentUser.house_points) || 0) + 1;
                awardedPoint = true;
            }

            if (currentUser) {
                // persist
                localStorage.setItem('peHubUser', JSON.stringify(currentUser));
                try {
                    // update in peHubUsers / users lists
                    const users = JSON.parse(localStorage.getItem('users') || '[]');
                    const idx = users.findIndex(u => (u.student_id || u.studentId || u.id) === (currentUser.student_id || currentUser.studentId || currentUser.id));
                    if (idx >= 0) {
                        users[idx] = { ...users[idx], house_points: currentUser.house_points, completed_quiz_levels: currentUser.completed_quiz_levels };
                    }
                    localStorage.setItem('users', JSON.stringify(users));
                } catch (e) {}
            }

            updateDashboard();

            // show completion screen
            showCompletionScreen({ correct, percent, pass, awardedPoint, isReward });
            activeQuiz = null;
        }

        function showCompletionScreen({ correct, percent, pass, awardedPoint, isReward }) {
            const container = document.getElementById('quizLevelView');
            if (!container) return;
            const msgColor = pass ? 'var(--accent-secondary)' : 'var(--house-red)';
            const rewardHtml = (isReward && awardedPoint) ? `<div style="margin-top:1rem;padding:1rem;border-radius:8px;background:linear-gradient(90deg,#ffd54f,#ffc107);color:#222;font-weight:800">CONGRATULATIONS! You Earned 1 House Point!</div>` : '';
            const specialStyle = isReward ? 'box-shadow:0 10px 30px rgba(255,193,7,0.25);border:3px solid #ffecb3' : '';
            document.getElementById('quizLevelTitle').textContent = `Quiz Result`;
            document.getElementById('quizIntro').innerHTML = `
                <div style="padding:1rem;background:var(--surface-light);border-radius:12px;${specialStyle};color:var(--text-light)">
                    <h3 style="margin-bottom:0.5rem">Score: ${correct}/10 ‚Äî ${percent}%</h3>
                    <div style="color:${msgColor};font-weight:700">${pass ? 'Passed' : 'Not Passed'}</div>
                    ${rewardHtml}
                    <div style="margin-top:1rem;text-align:right"><button id="returnToMap" class="quiz-btn">Return to Quiz Map</button></div>
                </div>
            `;
            setTimeout(()=>{
                const b = document.getElementById('returnToMap');
                if (b) b.addEventListener('click', ()=> {
                    switchTab('quiz');
                    // ensure quiz map visible
                    const qTab = document.getElementById('quizTab');
                    if (qTab) qTab.classList.remove('hidden');
                    populateQuizMap();
                });
            },50);
        }

        // Initialize quiz bank and map on load
        try {
            buildQuizBank();
            populateQuizMap();
        } catch (e) {
            console.warn('Quiz bank initialization failed', e);
        }
    </script>
</body>
</html>